

<!DOCTYPE html>
<html lang="cn" color-mode=light>
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <title>K8S企业部署实战 - Source Blog</title>
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="google" content="notranslate" />
  
  <meta name="description" content="K8S企业部署实战部署架构图1584700891603...">
  <meta name="author" content="source">
  <link rel="icon" href="/images/icons/favicon-16x16.png" type="image/png" sizes="16x16">
  <link rel="icon" href="/images/icons/favicon-32x32.png" type="image/png" sizes="32x32">
  <link rel="apple-touch-icon" href="/images/icons/apple-touch-icon.png" sizes="180x180">
  <meta rel="mask-icon" href="/images/icons/stun-logo.svg" color="#333333">
  
    <meta rel="msapplication-TileImage" content="/images/icons/favicon-144x144.png">
    <meta rel="msapplication-TileColor" content="#000000">
  

  
<link rel="stylesheet" href="/css/style.css">


  
    
<link rel="stylesheet" href="//at.alicdn.com/t/font_1445822_r673sha78lq.css">

  

  
    
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.7/jquery.fancybox.min.css">

  

  
    
      
        
        
<link rel="stylesheet" href="https://cdn.bootcss.com/highlight.js/9.18.1/styles/xcode.min.css" name="highlight-style" mode="light">

      
        
        
<link rel="stylesheet" href="https://cdn.bootcss.com/highlight.js/9.18.1/styles/solarized-dark.min.css" name="highlight-style" mode="dark">

      
  

  <script>
    var CONFIG = window.CONFIG || {};
    var ZHAOO = window.ZHAOO || {};
    CONFIG = {
      isHome: false,
      fancybox: true,
      pjax: false,
      lazyload: {
        enable: true,
        only_post: 'false',
        loading: '[object Object]'
      },
      donate: {
        enable: true,
        alipay: 'https://pic.izhaoo.com/alipay.jpg',
        wechat: 'https://pic.izhaoo.com/wechat.jpg'
      },
      galleries: {
        enable: true
      },
      fab: {
        enable: true,
        always_show: false
      },
      carrier: {
        enable: true
      },
      daovoice: {
        enable: false
      },
      preview: {
        background: {
          default: '',
          api: ''
        },
        motto: {
          default: '心之所动，就随风去吧。',
          typing: true,
          api: '',
          data_contents: '["data","content"]'
        },
      },
      qrcode: {
        enable: true,
        type: 'url',
        image: 'https://pic.izhaoo.com/weapp-code.jpg',
      },
      toc: {
        enable: true
      },
      scrollbar: {
        type: 'default'
      },
      notification: {
        enable: false,
        delay: 4500,
        list: '',
        page_white_list: '',
        page_black_list: ''
      },
      search: {
        enable: false,
        path: ''
      }
    }
  </script>

  

  

<meta name="generator" content="Hexo 5.4.0"></head>

<body class="lock-screen">
  <div class="loading"></div>
  
    


  <nav class="navbar">
    <div class="left">
      
        <i class="iconfont iconhome j-navbar-back-home"></i>
      
      
        <i class="iconfont iconqrcode j-navbar-qrcode"></i>
      
      
        <i class="iconfont iconmoono" id="color-toggle" color-toggle="light"></i>
      
      
    </div>
    <div class="center">K8S企业部署实战</div>
    <div class="right">
      <i class="iconfont iconmenu j-navbar-menu"></i>
    </div>
    
      <div id="qrcode-navbar"></div>
    
  </nav>

  
  

<nav class="menu">
  <div class="menu-container">
    <div class="menu-close">
      <i class="iconfont iconbaseline-close-px"></i>
    </div>
    <ul class="menu-content"><li class="menu-item">
        <a href="/ " class="underline "> 首页</a>
      </li><li class="menu-item">
        <a href="/galleries/ " class="underline "> 摄影</a>
      </li><li class="menu-item">
        <a href="/archives/ " class="underline "> 归档</a>
      </li><li class="menu-item">
        <a href="/tags/ " class="underline "> 标签</a>
      </li><li class="menu-item">
        <a href="/categories/ " class="underline "> 分类</a>
      </li><li class="menu-item">
        <a href="/about/ " class="underline "> 关于</a>
      </li></ul>
    
      <div class="menu-copyright"><p>Powered by <a target="_blank" href="https://hexo.io">Hexo</a>  |  Theme - <a target="_blank" href="https://github.com/izhaoo/hexo-theme-zhaoo">zhaoo</a></p></div>
    
  </div>
</nav>
  <main id="main">
  <div class="article-wrap">
    <div class="row container">
      <div class="col-xl-3"></div>
      <div class="col-xl-6"><article class="article">
  <div class="wrap">
    <section class="head">
  <img   class="lazyload" data-original="/images/theme/post-image.jpg" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  draggable="false">
  <div class="head-mask">
    <h1 class="head-title">K8S企业部署实战</h1>
    <div class="head-info">
      <span class="post-info-item"><i class="iconfont iconcalendar"></i>December 15, 2021</span>
      
      <span class="post-info-item"><i class="iconfont iconfont-size"></i>56241</span>
    </div>
  </div>
</section>
    <section class="main">
      <section class="content">
        <h1 id="K8S企业部署实战"><a href="#K8S企业部署实战" class="headerlink" title="K8S企业部署实战"></a>K8S企业部署实战</h1><h2 id="部署架构图"><a href="#部署架构图" class="headerlink" title="部署架构图"></a><strong>部署架构图</strong></h2><p><img    class="lazyload" data-original="https://gitee.com/hackxu/img/raw/master/docker/202110291659867.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="   ><span class="image-caption">1584700891603</span></p>
<blockquote>
<p>11机器：反向代理</p>
<p>12机器：反向代理</p>
<p>21机器：主控+运算节点（即服务群都是跑在21和22上）</p>
<p>22机器：主控+运算节点（生产上我们会把主控和运算分开）</p>
<p>200机器：运维主机（放各种文件资源）</p>
<p>这样控节点有两个，运算节点有两个，就是小型的分布式，现在你可能没办法理解这些内容，我们接着做下去，慢慢的，你就理解了</p>
</blockquote>
<h2 id="实验环境准备"><a href="#实验环境准备" class="headerlink" title="实验环境准备"></a><strong>实验环境准备</strong></h2><p>使用我的镜像包或者任意7.6以上版本的centos，Xshell和VMware</p>
<blockquote>
<p>7.6镜像网上资源少，这里提供一个：<a target="_blank" rel="noopener" href="https://pan.baidu.com/s/1mkIzua1XQmew240XBbvuFA">https://pan.baidu.com/s/1mkIzua1XQmew240XBbvuFA</a> 提取码：7p6h 。注意：镜像包的network是ens33，我用的是eth0，下面你就知道在哪用了，你也可以改成跟我一样，这是百度经验<a target="_blank" rel="noopener" href="https://jingyan.baidu.com/article/17bd8e524c76a285ab2bb8ff.html">https://jingyan.baidu.com/article/17bd8e524c76a285ab2bb8ff.html</a></p>
<p>这个镜像的网卡名默认是ens33，建议修改成eth0：<a target="_blank" rel="noopener" href="https://jingyan.baidu.com/article/17bd8e524c76a285ab2bb8ff.html">https://jingyan.baidu.com/article/17bd8e524c76a285ab2bb8ff.html</a></p>
</blockquote>
<h3 id="虚拟机网络设置"><a href="#虚拟机网络设置" class="headerlink" title="虚拟机网络设置"></a><strong>虚拟机网络设置</strong></h3><p><img    class="lazyload" data-original="https://gitee.com/hackxu/img/raw/master/docker/202110291659748.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="   ><span class="image-caption">image-20211019223229724</span></p>
<p><strong>宿主机</strong></p>
<p><img    class="lazyload" data-original="https://gitee.com/hackxu/img/raw/master/docker/202110251653785.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="   ><span class="image-caption">image-20211025165348731</span></p>
<h4 id="样板机配置虚拟机网络"><a href="#样板机配置虚拟机网络" class="headerlink" title="样板机配置虚拟机网络"></a>样板机配置虚拟机网络</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">按此链接修改网卡名称:https://jingyan.baidu.com/article/17bd8e524c76a285ab2bb8ff.html</span><br><span class="line"><span class="meta">#</span><span class="bash">有的是ens33,改完网卡配置后是eth0</span></span><br><span class="line">cd /etc/sysconfig/network-scripts/</span><br><span class="line">vi ifcfg-eth0</span><br><span class="line"><span class="meta">#</span><span class="bash">进行如下图配置</span></span><br></pre></td></tr></table></figure>

<p><img    class="lazyload" data-original="https://gitee.com/hackxu/img/raw/master/docker/202110291659642.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="   ><span class="image-caption">image-20211020110213504</span></p>
<p><img    class="lazyload" data-original="https://gitee.com/hackxu/img/raw/master/docker/202110201107625.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="   ><span class="image-caption">image-20211020110723583</span></p>
<h4 id="根据拓扑克隆5台样板机"><a href="#根据拓扑克隆5台样板机" class="headerlink" title="根据拓扑克隆5台样板机"></a>根据拓扑克隆5台样板机</h4><p><img    class="lazyload" data-original="https://gitee.com/hackxu/img/raw/master/docker/202110291659674.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="   ><span class="image-caption">image-20211019223922003</span></p>
<h4 id="对5台样板机进行配置"><a href="#对5台样板机进行配置" class="headerlink" title="对5台样板机进行配置"></a>对5台样板机进行配置</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">ip为11的后缀改为11,为21的改成21以此类推</span></span><br><span class="line">hostnamectl set-hostname hdss7-11</span><br><span class="line"></span><br><span class="line">cd /etc/sysconfig/network-scripts/</span><br><span class="line">vi ifcfg-eth0</span><br><span class="line"><span class="meta">#</span><span class="bash">修改一下IPADDR为10.4.7.11以此类推</span></span><br><span class="line"></span><br><span class="line">重启网卡</span><br><span class="line"><span class="meta">#</span><span class="bash">systemctl restart network</span></span><br></pre></td></tr></table></figure>

<p>类似这样：</p>
<p><img    class="lazyload" data-original="https://gitee.com/hackxu/img/raw/master/docker/202110201127842.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="   ><span class="image-caption">image-20211020112747794</span></p>
<p><strong>Xshell发送命令到全部会话</strong></p>
<p><img    class="lazyload" data-original="https://gitee.com/hackxu/img/raw/master/docker/202110291659330.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="   ><span class="image-caption">image-20211020140535516</span></p>
<h3 id="关闭防火墙和SElinux（很重要！！！！）"><a href="#关闭防火墙和SElinux（很重要！！！！）" class="headerlink" title="关闭防火墙和SElinux（很重要！！！！）"></a>关闭防火墙和SElinux（很重要！！！！）</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">查看内核版本</span></span><br><span class="line">uname -a</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash">关闭SElinux</span></span><br><span class="line">setenforce 0</span><br><span class="line"><span class="meta">#</span><span class="bash">使用getenforce检查是否关闭应为<span class="built_in">disable</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash">暂时关闭setenforce 0</span> </span><br><span class="line"><span class="meta">#</span><span class="bash">永久关闭，改配置文件 vi /etc/selinux/config SELINUX=disabled</span></span><br><span class="line">getenforce</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash">关闭防火墙</span></span><br><span class="line">systemctl stop firewalld</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash">安装epel源</span></span><br><span class="line">yum install epel-release</span><br><span class="line">yum install wget net-tools telnet tree nmap sysstat lrzsz dos2unix bind-utils -y </span><br></pre></td></tr></table></figure>

<h3 id="11机器配置DNS服务"><a href="#11机器配置DNS服务" class="headerlink" title="11机器配置DNS服务"></a>11机器配置DNS服务</h3><h4 id="11机器-bind9安装部署（DNS服务）"><a href="#11机器-bind9安装部署（DNS服务）" class="headerlink" title="11机器-bind9安装部署（DNS服务）"></a>11机器-bind9安装部署（DNS服务）</h4><p><strong>我们要用ingress，在K8S里要做7层调度，而且无论如何都要用域名（如之前的那个百度页面的域名，那个是host的方式），但是问题是我们怎么给K8S里的容器绑host，所以我们必须做一个DNS，然后容器服从我们的DNS解析调度</strong></p>
<p><strong>200机器上</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">安装<span class="built_in">bind</span></span></span><br><span class="line">yum install bind -y</span><br><span class="line"></span><br><span class="line">[root@hdss7-200 ~]# yum install bind -y</span><br><span class="line">[root@hdss7-200 ~]# rpm -qa bind</span><br><span class="line">bind-9.11.4-26.P2.el7_9.7.x86_64</span><br><span class="line">[root@hdss7-200 ~]# </span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash">配置主配置文件，11机器</span></span><br><span class="line">vi /etc/named.conf</span><br><span class="line"></span><br><span class="line">listen-on port 53 &#123; 10.4.7.11; &#125;;  # 原本是127.0.0.1</span><br><span class="line"><span class="meta">#</span><span class="bash"> listen-on-v6 port 53 &#123; ::1; &#125;;  <span class="comment"># 需要删掉</span></span></span><br><span class="line">allow-query     &#123; any; &#125;;  # 原本是locall</span><br><span class="line">forwarders      &#123; 10.4.7.254; &#125;;  #另外添加的，向上解析</span><br><span class="line">dnssec-enable no;  # 原本是yes</span><br><span class="line">dnssec-validation no;  # 原本是yes</span><br><span class="line"><span class="meta">#</span><span class="bash"> 检查修改情况，没有报错即可（即没有信息）</span></span><br></pre></td></tr></table></figure>

<blockquote>
<ul>
<li><strong>listen-on</strong>：监听端口，改为监听在内网，这样其它机器也可以用</li>
<li><strong>allow-query</strong>：哪些客户端能通过自建的DNS查</li>
<li><strong>forwarders</strong>：上级DNS是什么</li>
</ul>
<p><strong>rpm</strong>：软件包管理器</p>
<ul>
<li><strong>-qa</strong>：查看已安装的所有软件包</li>
</ul>
<p><strong>rpm和yum安装的区别</strong>：前者不检查相依性问题，后者检查（即相关依赖包）</p>
</blockquote>
<h4 id="主配置文件"><a href="#主配置文件" class="headerlink" title="主配置文件"></a>主配置文件</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">11机器，经验：主机域一定得跟业务是一点关系都没有，如host.com，而业务用的是od.com，因为业务随时可能变</span><br><span class="line"><span class="meta">#</span><span class="bash"> 区域配置文件，加在最下面</span></span><br><span class="line">vi /etc/named.rfc1912.zones</span><br><span class="line"></span><br><span class="line">[root@hdss7-11 ~]# vi /etc/named.rfc1912.zones </span><br><span class="line">zone &quot;host.com&quot; IN &#123;</span><br><span class="line">        type  master;</span><br><span class="line">        file  &quot;host.com.zone&quot;;</span><br><span class="line">        allow-update &#123; 10.4.7.11; &#125;;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">zone &quot;od.com&quot; IN &#123;</span><br><span class="line">        type  master;</span><br><span class="line">        file  &quot;od.com.zone&quot;;</span><br><span class="line">        allow-update &#123; 10.4.7.11; &#125;;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p><img    class="lazyload" data-original="https://gitee.com/hackxu/img/raw/master/docker/202110210017066.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="   ><span class="image-caption">image-20211021001726029</span></p>
<h4 id="区域配置文件"><a href="#区域配置文件" class="headerlink" title="区域配置文件"></a>区域配置文件</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"># 11机器新建文件添加如下内容：</span><br><span class="line"># 注意serial行的时间，代表今天的时间+第一条记录：20200112+01</span><br><span class="line"></span><br><span class="line">[root@hdss7-11 named]# vi /var/named/host.com.zone</span><br><span class="line">$ORIGIN host.com.</span><br><span class="line">$TTL 600	; 10 minutes</span><br><span class="line">@       IN SOA	dns.host.com. dnsadmin.host.com. (</span><br><span class="line">				2021102101 ; serial</span><br><span class="line">				10800      ; refresh (3 hours)</span><br><span class="line">				900        ; retry (15 minutes)</span><br><span class="line">				604800     ; expire (1 week)</span><br><span class="line">				86400      ; minimum (1 day)</span><br><span class="line">				)</span><br><span class="line">			NS   dns.host.com.</span><br><span class="line">$TTL 60	; 1 minute</span><br><span class="line">dns                A    10.4.7.11</span><br><span class="line">HDSS7-11           A    10.4.7.11</span><br><span class="line">HDSS7-12           A    10.4.7.12</span><br><span class="line">HDSS7-21           A    10.4.7.21</span><br><span class="line">HDSS7-22           A    10.4.7.22</span><br><span class="line">HDSS7-200          A    10.4.7.200</span><br><span class="line"></span><br><span class="line">[root@hdss7-11 named]# vi /var/named/od.com.zone</span><br><span class="line">$ORIGIN od.com.</span><br><span class="line">$TTL 600	; 10 minutes</span><br><span class="line">@   		IN SOA	dns.od.com. dnsadmin.od.com. (</span><br><span class="line">				2021102101 ; serial</span><br><span class="line">				10800      ; refresh (3 hours)</span><br><span class="line">				900        ; retry (15 minutes)</span><br><span class="line">				604800     ; expire (1 week)</span><br><span class="line">				86400      ; minimum (1 day)</span><br><span class="line">				)</span><br><span class="line">				NS   dns.od.com.</span><br><span class="line">$TTL 60	; 1 minute</span><br><span class="line">dns                A    10.4.7.11</span><br><span class="line"></span><br><span class="line"># 看一下有没有报错</span><br><span class="line">[root@hdss7-11 named]# named-checkconf </span><br><span class="line">[root@hdss7-11 named]# systemctl start named</span><br><span class="line">[root@hdss7-11 named]# netstat -tunlp|grep 53</span><br><span class="line">tcp        0      0 10.4.7.11:53            0.0.0.0:*               LISTEN      7206/named          </span><br><span class="line">tcp        0      0 127.0.0.1:953           0.0.0.0:*               LISTEN      7206/named          </span><br><span class="line">tcp6       0      0 ::1:953                 :::*                    LISTEN      7206/named          </span><br><span class="line">udp        0      0 10.4.7.11:53            0.0.0.0:*                           7206/named   </span><br></pre></td></tr></table></figure>

<blockquote>
<p><strong>TTL 600</strong>：指定IP包被路由器丢弃之前允许通过的最大网段数量</p>
<ul>
<li><strong>10 minutes</strong>：过期时间10分钟</li>
</ul>
<p><strong>SOA</strong>：一个域权威记录的相关信息，后面有5组参数分别设定了该域相关部分</p>
<ul>
<li><strong>dnsadmin.od.com.</strong> 一个假的邮箱</li>
<li><strong>serial</strong>：记录的时间</li>
</ul>
<p><strong>$ORIGIN</strong>：即下列的域名自动补充od.com，如dns，外面看来是dns.od.com</p>
<p><strong>netstat -luntp</strong>：显示 tcp,udp 的端口和进程等相关情况</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"># 11机器，检查主机域是否解析</span><br><span class="line">dig -t A hdss7-21.host.com @10.4.7.11 +short</span><br><span class="line">[root@hdss7-11 named]# dig -t A hdss7-21.host.com @10.4.7.11 +short</span><br><span class="line">10.4.7.21</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 配置linux客户端和win客户端都能使用这个服务，修改</span><br><span class="line">[root@hdss7-11 named]# vi /etc/sysconfig/network-scripts/ifcfg-eth0</span><br><span class="line">DNS1=10.4.7.11</span><br><span class="line">[root@hdss7-11 named]# systemctl restart network</span><br><span class="line">[root@hdss7-11 named]# ping www.baidu.com</span><br><span class="line">[root@hdss7-11 named]# ping hdss7-21.host.com</span><br></pre></td></tr></table></figure>

<blockquote>
<p><strong>dig -t A</strong>：指的是找DNS里标记为A的相关记录，而后面会带上相关的域，如上面的hdss7-21.host.com，为什么外面配了HDSS7-21后面还会自动接上.host.com就是因为$ORIGIN，后面则是对应的IP</p>
<ul>
<li><strong>+short</strong>：表示只返回IP</li>
</ul>
</blockquote>
<p><img    class="lazyload" data-original="https://gitee.com/hackxu/img/raw/master/docker/202110210035510.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="   ><span class="image-caption">image-20211021003507468</span></p>
<h4 id="添加短域名-配置好短域名后不用重启网卡不然会失效"><a href="#添加短域名-配置好短域名后不用重启网卡不然会失效" class="headerlink" title="添加短域名(配置好短域名后不用重启网卡不然会失效)"></a>添加短域名(配置好短域名后不用重启网卡不然会失效)</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 在所有机器添加search... ，即可使用短域名（我的是自带的）</span></span><br><span class="line">vi /etc/resolv.conf</span><br><span class="line"><span class="meta">#</span><span class="bash">添加search host.com</span></span><br><span class="line">ping hdss7-200</span><br><span class="line"></span><br><span class="line">[root@hdss7-11 named]# vi /etc/resolv.conf</span><br><span class="line">[root@hdss7-11 named]# ping hdss7-11</span><br><span class="line">PING HDSS7-11.host.com (10.4.7.11) 56(84) bytes of data.</span><br><span class="line">64 bytes from hdss7-11 (10.4.7.11): icmp_seq=1 ttl=64 time=0.007 ms</span><br><span class="line">64 bytes from hdss7-11 (10.4.7.11): icmp_seq=2 ttl=64 time=0.024 ms</span><br><span class="line">64 bytes from hdss7-11 (10.4.7.11): icmp_seq=3 ttl=64 time=0.022 ms</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><img    class="lazyload" data-original="https://gitee.com/hackxu/img/raw/master/docker/202110291659545.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="   ><span class="image-caption">image-20211021003905502</span></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 在非11机器上，全部改成11</span></span><br><span class="line">[root@hdss7-12 ~]# vi /etc/sysconfig/network-scripts/ifcfg-eth0</span><br><span class="line">DNS1=10.4.7.11</span><br><span class="line"></span><br><span class="line">[root@hdss7-12 ~]# systemctl restart network</span><br><span class="line"><span class="meta">#</span><span class="bash"> 试下网络是否正常</span></span><br><span class="line">[root@hdss7-12 ~]# ping baidu.com</span><br><span class="line"><span class="meta">#</span><span class="bash"> 其它机器尝试ping7-11机器</span></span><br><span class="line">[root@hdss7-12 ~]# ping hdss7-11.host.com</span><br></pre></td></tr></table></figure>

<p><img    class="lazyload" data-original="https://gitee.com/hackxu/img/raw/master/docker/202110291659903.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="   ><span class="image-caption">image-20211021125525013</span></p>
<h4 id="修改windows配置，并且ping"><a href="#修改windows配置，并且ping" class="headerlink" title="修改windows配置，并且ping"></a>修改windows配置，并且ping</h4><p><img    class="lazyload" data-original="https://gitee.com/hackxu/img/raw/master/docker/202110291659932.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="   ><span class="image-caption">image-20211021125710752</span></p>
<p><img    class="lazyload" data-original="https://gitee.com/hackxu/img/raw/master/docker/202110211258543.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="   ><span class="image-caption">image-20211021125819510</span></p>
<p>完成。</p>
<h3 id="准备签发证书环境"><a href="#准备签发证书环境" class="headerlink" title="准备签发证书环境"></a>准备签发证书环境</h3><p><strong>运维主机hdss7-200上</strong></p>
<blockquote>
<p>证书，可以用来审计也可以保障安全，k8S组件启动的时候，则需要有对应的证书，证书的详解你也可以在网上搜到</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> cfssl方式做证书，需要三个软件，按照我们的架构图，我们部署在200机器:</span></span><br><span class="line">wget https://pkg.cfssl.org/R1.2/cfssl_linux-amd64 -O /usr/bin/cfssl</span><br><span class="line">wget https://pkg.cfssl.org/R1.2/cfssljson_linux-amd64 -O /usr/bin/cfssl-json</span><br><span class="line">wget https://pkg.cfssl.org/R1.2/cfssl-certinfo_linux-amd64 -O /usr/bin/cfssl-certinfo</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash">这样下载可能很慢下载不下来，推荐用涛哥的七牛云镜像</span></span><br><span class="line">[root@hdss7-200 ~]wget https://pkg.cfssl.org/R1.2/cfssl_linux-amd64 -O /usr/bin/cfssl</span><br><span class="line">[root@hdss7-200 ~]wget https://pkg.cfssl.org/R1.2/cfssljson_linux-amd64 -O /usr/bin/cfssl-json</span><br><span class="line">[root@hdss7-200 ~]wget https://pkg.cfssl.org/R1.2/cfssl-certinfo_linux-amd64 -O /usr/bin/cfssl-certinfo</span><br><span class="line"></span><br><span class="line">wget http://r102n3zvk.hd-bkt.clouddn.com/cfssl/1.2.0/cfssl_linux-amd64 -O /usr/bin/cfssl</span><br><span class="line">wget http://r102n3zvk.hd-bkt.clouddn.com/cfssl/1.2.0/cfssljson_linux-amd64 -O /usr/bin/cfssl-json</span><br><span class="line">wget http://r102n3zvk.hd-bkt.clouddn.com/cfssl/1.2.0/cfssl-certinfo_linux-amd64 -O /usr/bin/cfssl-certinfo</span><br><span class="line"></span><br><span class="line">[root@hdss7-200 ~]chmod +x /usr/bin/cfssl*</span><br><span class="line">[root@hdss7-200 ~]which cfssl</span><br><span class="line">[root@hdss7-200 ~]which cfssl-json</span><br><span class="line">[root@hdss7-200 ~]which cfssl-certinfo</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@hdss7-200 opt]# cd /opt/</span><br><span class="line">[root@hdss7-200 opt]# mkdir certs</span><br><span class="line">[root@hdss7-200 opt]# vi ca-csr.json</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">    &quot;CN&quot;: &quot;ben123123&quot;,</span><br><span class="line">    &quot;hosts&quot;: [</span><br><span class="line">    ],</span><br><span class="line">    &quot;key&quot;: &#123;</span><br><span class="line">        &quot;algo&quot;: &quot;rsa&quot;,</span><br><span class="line">        &quot;size&quot;: 2048</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;names&quot;: [</span><br><span class="line">        &#123;</span><br><span class="line">            &quot;C&quot;: &quot;CN&quot;,</span><br><span class="line">            &quot;ST&quot;: &quot;beijing&quot;,</span><br><span class="line">            &quot;L&quot;: &quot;beijing&quot;,</span><br><span class="line">            &quot;O&quot;: &quot;od&quot;,</span><br><span class="line">            &quot;OU&quot;: &quot;ops&quot;</span><br><span class="line">        &#125;</span><br><span class="line">    ],</span><br><span class="line">    &quot;ca&quot;: &#123;</span><br><span class="line">        &quot;expiry&quot;: &quot;175200h&quot;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">#</span><span class="bash">迁移证书</span></span><br><span class="line">[root@hdss7-200 opt]# cfssl gencert -initca ca-csr.json | cfssl-json -bare ca</span><br><span class="line">[root@hdss7-200 opt]# cat ca.pem</span><br><span class="line"><span class="meta">#</span><span class="bash"> 如果你这时候显示段错误或者json错误，就是之前克隆虚拟机的时候200机器地址和别的机器地址重叠冲突了，需要重建200虚拟机</span></span><br></pre></td></tr></table></figure>

<p><img    class="lazyload" data-original="https://gitee.com/hackxu/img/raw/master/docker/202110291659291.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="   ><span class="image-caption">image-20211021142400336</span></p>
<blockquote>
<p><strong>cfssl</strong>：证书工具</p>
<ul>
<li>gencert：生成的意思</li>
</ul>
<p><strong>ca-csr.json解析：</strong></p>
<ul>
<li>CN：Common Name，浏览器使用该字段验证网址是否合法，一般写域名，非常重要</li>
<li>ST：State，省</li>
<li>L：Locality，地区</li>
<li>O：Organization Name，组织名称</li>
<li>OU：Organization Unit Name，组织单位名称</li>
</ul>
</blockquote>
<h3 id="部署Docker环境"><a href="#部署Docker环境" class="headerlink" title="部署Docker环境"></a>部署Docker环境</h3><p><strong>21、22、200机器</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 如我们架构图所示，运算节点是21/22机器（没有docker则无法运行pod），运维主机是200机器（没有docker则没办法下载docker存入私有仓库），所以在三台机器安装（21/22/200）</span></span><br><span class="line">curl -fsSL https://get.docker.com | bash -s docker --mirror Aliyun</span><br><span class="line"><span class="meta">#</span><span class="bash"> 上面的下载可能网络有问题，需要多试几次，这些部署我已经不同机器试过很多次了</span></span><br><span class="line"></span><br><span class="line">mkdir -p /data/docker /etc/docker</span><br><span class="line"><span class="meta">#</span><span class="bash"> <span class="comment"># 注意，172.7.21.1，这里得21是指在hdss7-21得机器，如果是22得机器，就是172.7.22.1，共一处需要改机器名：&quot;bip&quot;: &quot;172.7.21.1/24&quot;</span></span></span><br><span class="line">vi /etc/docker/daemon.json</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">  &quot;graph&quot;: &quot;/data/docker&quot;,</span><br><span class="line">  &quot;storage-driver&quot;: &quot;overlay2&quot;,</span><br><span class="line">  &quot;insecure-registries&quot;: [&quot;registry.access.redhat.com&quot;,&quot;quay.io&quot;,&quot;harbor.od.com&quot;],</span><br><span class="line">  &quot;registry-mirrors&quot;: [&quot;https://q2gr04ke.mirror.aliyuncs.com&quot;],</span><br><span class="line">  &quot;bip&quot;: &quot;172.7.21.1/24&quot;,</span><br><span class="line">  &quot;exec-opts&quot;: [&quot;native.cgroupdriver=systemd&quot;],</span><br><span class="line">  &quot;live-restore&quot;: true</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">systemctl start docker</span><br><span class="line">docker version</span><br><span class="line">docker ps -a</span><br></pre></td></tr></table></figure>

<p><img    class="lazyload" data-original="https://gitee.com/hackxu/img/raw/master/docker/202110291659325.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="   ><span class="image-caption">image-20211025131000765</span></p>
<h3 id="部署docker私有镜像仓库"><a href="#部署docker私有镜像仓库" class="headerlink" title="部署docker私有镜像仓库"></a>部署docker私有镜像仓库</h3><h4 id="下载软件二进制包解压安装"><a href="#下载软件二进制包解压安装" class="headerlink" title="下载软件二进制包解压安装"></a>下载软件二进制包解压安装</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 如架构图，我们安装在200机器：</span></span><br><span class="line">cd /opt</span><br><span class="line">200 opt]# mkdir src</span><br><span class="line">200 opt]# cd src/</span><br><span class="line"><span class="meta">#</span><span class="bash"> 直接去涛哥的七牛云下载速度贼快</span></span><br><span class="line">wget http://r102n3zvk.hd-bkt.clouddn.com/harbor/1.8.3/harbor-offline-installer-v1.8.3.tar</span><br><span class="line">[root@hdss7-200 ~]# tar xf harbor-offline-installer-v1.8.3.tar -C /opt/</span><br></pre></td></tr></table></figure>



<blockquote>
<p><strong>tar</strong>：可以加入，解开备份文件内的文件</p>
<ul>
<li><strong>x</strong>：解压</li>
<li><strong>f</strong>： 使用档案名字</li>
<li><strong>-C</strong>：切换到指定的目录</li>
<li>整条命令合起来就是，把tar文件以tar文件名为名字解压到opt目录下，并保存tar文件原样</li>
</ul>
<p><strong>关于版本</strong>：一般人都是喜欢用比较新的版本，我们当然也支持比较新的版本，但对于公司而已，稳定是最要紧的，v1.8.3是用的比较稳定的版本，而后续的各个组件也会有更加新的版本，你可以尝试新版本，但有些由于兼容问题不能用新的，后续那些不能用我会标记清楚。</p>
</blockquote>
<h4 id="将harbor进行DNS解析（harbor-od-com）"><a href="#将harbor进行DNS解析（harbor-od-com）" class="headerlink" title="将harbor进行DNS解析（harbor.od.com）"></a>将harbor进行DNS解析（harbor.od.com）</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 200机器：</span></span><br><span class="line">[root@hdss7-200 ~]<span class="comment"># cd /opt/</span></span><br><span class="line">[root@hdss7-200 ~]<span class="comment"># mv harbor/ harbor-v1.8.3</span></span><br><span class="line">[root@hdss7-200 ~]<span class="comment"># ln -s /opt/harbor-v1.8.3/ /opt/harbor</span></span><br><span class="line">[root@hdss7-200 ~]<span class="comment"># cd harbor</span></span><br><span class="line">[root@hdss7-200 ~]<span class="comment"># ll</span></span><br><span class="line">[root@hdss7-200 ~]<span class="comment"># vi harbor.yml</span></span><br><span class="line"><span class="comment">#下面为需要修改的地方</span></span><br><span class="line">hostname: harbor.od.com  <span class="comment"># 原reg.mydomain.com</span></span><br><span class="line">http:</span><br><span class="line">  port: 180  <span class="comment"># 原80</span></span><br><span class="line">data_volume: /data/harbor</span><br><span class="line">location: /data/harbor/logs</span><br></pre></td></tr></table></figure>

<p><img    class="lazyload" data-original="https://gitee.com/hackxu/img/raw/master/docker/202110251321150.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="   ><span class="image-caption">image-20211025132111101</span></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-200 harbor]# mkdir -p /data/harbor/logs</span><br><span class="line">[root@hdss7-200 harbor]# yum install docker-compose -y</span><br><span class="line">[root@hdss7-200 harbor]# rpm -qa docker-compose</span><br><span class="line"><span class="meta">#</span><span class="bash"> out: docker-compose-1.18.0-4.el7.noarch</span></span><br><span class="line">[root@hdss7-200 harbor]# ./install.sh</span><br></pre></td></tr></table></figure>

<p><img    class="lazyload" data-original="https://gitee.com/hackxu/img/raw/master/docker/202110251325341.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="   ><span class="image-caption">image-20211025132539283</span></p>
<blockquote>
<p><strong>mv</strong>：为文件或目录改名、或将文件或目录移入其它位置。</p>
<ul>
<li>这里的命令是有斜杠的，所以是移动到某个目录下</li>
</ul>
<p><strong>ln</strong>：为某一个文件在另外一个位置建立一个同步的链接</p>
<ul>
<li><code>语法:ln [参数][源文件或目录][目标文件或目录]</code></li>
<li><code>**-s：**软连接，可以对整个目录进行链接</code></li>
</ul>
<p><strong>harbor.yml解析：</strong></p>
<ul>
<li>port为什么改成180：因为后面我们要装nginx，nginx用的80，所以要把它们错开</li>
<li>data_volume：数据卷，即docker镜像放在哪里</li>
<li>location：日志文件</li>
<li>./install.sh：启动shell脚本</li>
</ul>
</blockquote>
<h4 id="启动nginx容器"><a href="#启动nginx容器" class="headerlink" title="启动nginx容器"></a>启动nginx容器</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 200机器：</span></span><br><span class="line">[root@hdss7-200 harbor]<span class="comment"># docker-compose ps</span></span><br><span class="line">[root@hdss7-200 harbor]<span class="comment"># docker ps -a</span></span><br><span class="line">[root@hdss7-200 harbor]<span class="comment"># yum install nginx -y</span></span><br><span class="line"></span><br><span class="line"><span class="comment">###相关报错问题：</span></span><br><span class="line">yum的时候报：/var/run/yum.pid 已被锁定，PID 为 1610 的另一个程序正在运行。</span><br><span class="line">另外一个程序锁定了 yum；等待它退出……</span><br><span class="line">网上统一的解决办法：直接在终端运行 rm -f /var/run/yum.pid 将该文件删除，然后再次运行yum。</span><br><span class="line"><span class="comment">###</span></span><br><span class="line"></span><br><span class="line">[root@hdss7-200 harbor]<span class="comment"># vi /etc/nginx/conf.d/harbor.od.com.conf</span></span><br><span class="line">server &#123;</span><br><span class="line">    listen       80;</span><br><span class="line">    server_name  harbor.od.com;</span><br><span class="line"></span><br><span class="line">    client_max_body_size 1000m;</span><br><span class="line"></span><br><span class="line">    location / &#123;</span><br><span class="line">        proxy_pass http://127.0.0.1:180;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">[root@hdss7-200 harbor]<span class="comment"># nginx -t</span></span><br><span class="line">[root@hdss7-200 harbor]<span class="comment"># systemctl start nginx</span></span><br><span class="line">[root@hdss7-200 harbor]<span class="comment"># systemctl enable nginx</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p><strong>nginx -t</strong>：测试<em>nginx</em>.conf配置文件中是否存在语法错误</p>
<p><strong>systemctl enable nginx</strong>：开机自动启动</p>
</blockquote>
<p><img    class="lazyload" data-original="https://gitee.com/hackxu/img/raw/master/docker/202110291659726.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="   ><span class="image-caption">image-20211025133614129</span></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"># 在11机器解析域名：</span><br><span class="line">vi /var/named/od.com.zone</span><br><span class="line"># 注意serial前滚一个序号</span><br><span class="line"># 最下面添加域名</span><br><span class="line">harbor             A    10.4.7.200</span><br><span class="line">systemctl restart named</span><br><span class="line">dig -t A harbor.od.com +short</span><br><span class="line"># out:10.4.7.200</span><br><span class="line"></span><br><span class="line">[root@hdss1-11 ~]# vi /var/named/od.com.zone</span><br><span class="line"></span><br><span class="line">$ORIGIN od.com.</span><br><span class="line">$TTL 600        ; 10 minutes</span><br><span class="line">@               IN SOA  dns.od.com. dnsadmin.od.com. (</span><br><span class="line">                                2021102502 ; serial</span><br><span class="line">                                10800      ; refresh (3 hours)</span><br><span class="line">                                900        ; retry (15 minutes)</span><br><span class="line">                                604800     ; expire (1 week)</span><br><span class="line">                                86400      ; minimum (1 day)</span><br><span class="line">                                )</span><br><span class="line">                                NS   dns.od.com.</span><br><span class="line">$TTL 60 ; 1 minute</span><br><span class="line">dns                A    10.4.7.11</span><br><span class="line">harbor             A    10.4.7.200</span><br><span class="line">~                                        </span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h4 id="测试harbor仓库正常显示"><a href="#测试harbor仓库正常显示" class="headerlink" title="测试harbor仓库正常显示"></a>测试harbor仓库正常显示</h4><p><strong>200机器上</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">curl harbor.od.com</span><br><span class="line"><span class="meta">#</span><span class="bash">发现502报错</span></span><br><span class="line">[root@hdss7-200 harbor]# curl harbor.od.com</span><br><span class="line">&lt;html&gt;</span><br><span class="line">&lt;head&gt;&lt;title&gt;502 Bad Gateway&lt;/title&gt;&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">&lt;center&gt;&lt;h1&gt;502 Bad Gateway&lt;/h1&gt;&lt;/center&gt;</span><br><span class="line">&lt;hr&gt;&lt;center&gt;nginx/1.20.1&lt;/center&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure>



<blockquote>
<p>注意：</p>
<p>getenforce得是关闭状态，而不是enforcing，否则会报502 </p>
<p>暂时关闭setenforce 0 </p>
<p>永久关闭，改配置文件 vi /etc/selinux/config SELINUX=disabled</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">正常情况</span></span><br><span class="line">curl harbor.od.com</span><br><span class="line">[root@hdss7-200 network-scripts]# curl harbor.od.com</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&lt;!doctype html&gt;</span><br><span class="line">&lt;html&gt;</span><br><span class="line"></span><br><span class="line">&lt;head&gt;</span><br><span class="line">    &lt;meta charset=&quot;utf-8&quot;&gt;</span><br><span class="line">    &lt;title&gt;Harbor&lt;/title&gt;</span><br><span class="line">    &lt;base href=&quot;/&quot;&gt;</span><br><span class="line">    &lt;meta name=&quot;viewport&quot; content=&quot;width=device-width, initial-scale=1&quot;&gt;</span><br><span class="line">    &lt;link rel=&quot;icon&quot; type=&quot;image/x-icon&quot; href=&quot;favicon.ico?v=2&quot;&gt;</span><br><span class="line">&lt;link rel=&quot;stylesheet&quot; href=&quot;styles.c1fdd265f24063370a49.css&quot;&gt;&lt;/head&gt;</span><br><span class="line"></span><br><span class="line">&lt;body&gt;</span><br><span class="line">    &lt;harbor-app&gt;</span><br><span class="line">        &lt;div class=&quot;spinner spinner-lg app-loading&quot;&gt;</span><br><span class="line">            Loading...</span><br><span class="line">        &lt;/div&gt;</span><br><span class="line">    &lt;/harbor-app&gt;</span><br><span class="line">&lt;script type=&quot;text/javascript&quot; src=&quot;runtime.26209474bfa8dc87a77c.js&quot;&gt;&lt;/script&gt;&lt;script type=&quot;text/javascript&quot; src=&quot;scripts.c04548c4e6d1db502313.js&quot;&gt;&lt;/script&gt;&lt;script type=&quot;text/javascript&quot; src=&quot;main.144e8ccd474a28572e81.js&quot;&gt;&lt;/script&gt;&lt;/body&gt;</span><br><span class="line"></span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure>

<p><img    class="lazyload" data-original="https://gitee.com/hackxu/img/raw/master/docker/202110291638461.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="   ><span class="image-caption">image-20211029163800359</span></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">登录名：admin	</span><br><span class="line">密码：Harbor12345</span><br><span class="line">登录账号密码可以在haobor.yml配置文件中修改</span><br><span class="line">新建一个公开的publicc</span><br></pre></td></tr></table></figure>



<p><img    class="lazyload" data-original="https://gitee.com/hackxu/img/raw/master/docker/202110291659943.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="   ><span class="image-caption">image-20211029162756696</span></p>
<h4 id="上传镜像到私有仓库"><a href="#上传镜像到私有仓库" class="headerlink" title="上传镜像到私有仓库"></a>上传镜像到私有仓库</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 200机器，尝试下是否能push成功到harbor仓库</span></span><br><span class="line">[root@hdss7-200 harbor]<span class="comment"># docker pull nginx:1.7.9</span></span><br><span class="line">[root@hdss7-200 harbor]<span class="comment"># docker images|grep 1.7.9</span></span><br><span class="line">[root@hdss7-200 harbor]<span class="comment"># docker tag 84581e99d807 harbor.od.com/public/nginx:v1.7.9</span></span><br><span class="line">[root@hdss7-200 harbor]<span class="comment"># docker login harbor.od.com</span></span><br><span class="line">账号：admin</span><br><span class="line">密码：Harbor12345</span><br><span class="line">[root@hdss7-200 harbor]<span class="comment"># docker push harbor.od.com/public/nginx:v1.7.9</span></span><br><span class="line"><span class="comment"># 报错：如果发现登录不上去了，过一阵子再登录即可，大约5分钟左右</span></span><br><span class="line"></span><br><span class="line">[root@hdss7-200 network-scripts]<span class="comment"># docker login harbor.od.com</span></span><br><span class="line">Username: admin</span><br><span class="line">Password: </span><br><span class="line">WARNING! Your password will be stored unencrypted <span class="keyword">in</span> /root/.docker/config.json.</span><br><span class="line">Configure a credential helper to remove this warning. See</span><br><span class="line">https://docs.docker.com/engine/reference/commandline/login/<span class="comment">#credentials-store</span></span><br><span class="line"></span><br><span class="line">Login Succeeded</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@hdss7-200 network-scripts]<span class="comment"># docker push harbor.od.com/public/nginx:v1.7.9</span></span><br><span class="line">The push refers to repository [harbor.od.com/public/nginx]</span><br><span class="line">5f70bf18a086: Pushed </span><br><span class="line">4b26ab29a475: Pushed </span><br><span class="line">ccb1d68e3fb7: Pushed </span><br><span class="line">e387107e2065: Pushed </span><br><span class="line">63bf84221cce: Pushed </span><br><span class="line">e02dce553481: Pushed </span><br><span class="line">dea2e4984e29: Pushed </span><br><span class="line">v1.7.9: digest: sha256:b1f5935eb2e9e2ae89c0b3e2e148c19068d91ca502e857052f14db230443e4c2 size: 3012</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><strong>镜像推送成功</strong></p>
<p><img    class="lazyload" data-original="https://gitee.com/hackxu/img/raw/master/docker/202110291659159.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="   ><span class="image-caption">image-20211029165845635</span></p>
<p><strong>此时成功安装私有镜像仓库了</strong></p>
<h3 id="安装部署主控节点服务etcd"><a href="#安装部署主控节点服务etcd" class="headerlink" title="安装部署主控节点服务etcd"></a>安装部署主控节点服务etcd</h3><blockquote>
<p><strong>WHAT</strong>：一个高可用强一致性的服务发现存储仓库，关于服务发现，其本质就是知道了集群中是否有进程在监听udp和tcp端口（如上面部署的harbor就是监听180端口），并且通过名字就可以查找和连接。</p>
<ul>
<li><strong>一个强一致性、高可用的服务存储目录</strong>：基于Raft算法的etcd天生就是这样</li>
<li><strong>一种注册服务和监控服务健康状态的机制</strong>：在etcd中注册服务，并且对注册的服务设置<code>key TTL</code>（TTL上面有讲到），定时保持服务的心跳以达到监控健康状态的效果</li>
<li><strong>一种查找和连接服务的机制</strong>：通过在etcd指定的主题下注册的服务也能在对应的主题下查找到，为了确保连接，我们可以在每个服务机器上都部署一个Proxy模式的etcd，这样就可以确保能访问etcd集群的服务都能互相连接</li>
</ul>
<p><strong>WHY</strong>：我们需要让服务快速透明地接入到计算集群中，让共享配置信息快速被集群中的所有机器发现</p>
</blockquote>
<p><strong>通过部署架构图可以看到有三台机器安装etcd，分别是12,21,22机器</strong></p>
<p><img    class="lazyload" data-original="https://gitee.com/hackxu/img/raw/master/docker/202110291711949.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="   ><span class="image-caption">image-20211029171112843</span></p>
<h4 id="生成etcd证书和私钥-200机器"><a href="#生成etcd证书和私钥-200机器" class="headerlink" title="生成etcd证书和私钥-200机器"></a>生成etcd证书和私钥-200机器</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 我们开始制作证书，200机器：</span></span><br><span class="line">[root@hdss7-200 certs]<span class="comment"># cd /opt/certs/</span></span><br><span class="line">[root@hdss7-200 certs]<span class="comment"># vi /opt/certs/ca-config.json</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">&quot;signing&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;default&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;expiry&quot;</span>: <span class="string">&quot;175200h&quot;</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">&quot;profiles&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;server&quot;</span>: &#123;</span><br><span class="line">                <span class="string">&quot;expiry&quot;</span>: <span class="string">&quot;175200h&quot;</span>,</span><br><span class="line">                <span class="string">&quot;usages&quot;</span>: [</span><br><span class="line">                    <span class="string">&quot;signing&quot;</span>,</span><br><span class="line">                    <span class="string">&quot;key encipherment&quot;</span>,</span><br><span class="line">                    <span class="string">&quot;server auth&quot;</span></span><br><span class="line">                ]</span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="string">&quot;client&quot;</span>: &#123;</span><br><span class="line">                <span class="string">&quot;expiry&quot;</span>: <span class="string">&quot;175200h&quot;</span>,</span><br><span class="line">                <span class="string">&quot;usages&quot;</span>: [</span><br><span class="line">                    <span class="string">&quot;signing&quot;</span>,</span><br><span class="line">                    <span class="string">&quot;key encipherment&quot;</span>,</span><br><span class="line">                    <span class="string">&quot;client auth&quot;</span></span><br><span class="line">                ]</span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="string">&quot;peer&quot;</span>: &#123;</span><br><span class="line">                <span class="string">&quot;expiry&quot;</span>: <span class="string">&quot;175200h&quot;</span>,</span><br><span class="line">                <span class="string">&quot;usages&quot;</span>: [</span><br><span class="line">                    <span class="string">&quot;signing&quot;</span>,</span><br><span class="line">                    <span class="string">&quot;key encipherment&quot;</span>,</span><br><span class="line">                    <span class="string">&quot;server auth&quot;</span>,</span><br><span class="line">                    <span class="string">&quot;client auth&quot;</span></span><br><span class="line">                ]</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">[root@hdss7-200 certs]<span class="comment"># vi etcd-peer-csr.json</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">&quot;CN&quot;</span>: <span class="string">&quot;k8s-etcd&quot;</span>,</span><br><span class="line">    <span class="string">&quot;hosts&quot;</span>: [</span><br><span class="line">        <span class="string">&quot;10.4.7.11&quot;</span>,</span><br><span class="line">        <span class="string">&quot;10.4.7.12&quot;</span>,</span><br><span class="line">        <span class="string">&quot;10.4.7.21&quot;</span>,</span><br><span class="line">        <span class="string">&quot;10.4.7.22&quot;</span></span><br><span class="line">    ],</span><br><span class="line">    <span class="string">&quot;key&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;algo&quot;</span>: <span class="string">&quot;rsa&quot;</span>,</span><br><span class="line">        <span class="string">&quot;size&quot;</span>: 2048</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">&quot;names&quot;</span>: [</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="string">&quot;C&quot;</span>: <span class="string">&quot;CN&quot;</span>,</span><br><span class="line">            <span class="string">&quot;ST&quot;</span>: <span class="string">&quot;beijing&quot;</span>,</span><br><span class="line">            <span class="string">&quot;L&quot;</span>: <span class="string">&quot;beijing&quot;</span>,</span><br><span class="line">            <span class="string">&quot;O&quot;</span>: <span class="string">&quot;od&quot;</span>,</span><br><span class="line">            <span class="string">&quot;OU&quot;</span>: <span class="string">&quot;ops&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">[root@hdss7-200 certs]<span class="comment"># cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=peer etcd-peer-csr.json |cfssl-json -bare etcd-peer</span></span><br><span class="line">[root@hdss7-200 certs]<span class="comment"># ll</span></span><br></pre></td></tr></table></figure>

<p><img    class="lazyload" data-original="https://gitee.com/hackxu/img/raw/master/docker/202110291718597.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="   ><span class="image-caption">image-20211029171837534</span></p>
<h4 id="安装etcd"><a href="#安装etcd" class="headerlink" title="安装etcd"></a>安装etcd</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 12/21/22机器，安装etcd：</span></span><br><span class="line">mkdir /opt/src</span><br><span class="line"><span class="built_in">cd</span> /opt/src/</span><br><span class="line"><span class="comment"># 创建用户</span></span><br><span class="line">useradd -s /sbin/nologin -M etcd</span><br><span class="line">id etcd</span><br><span class="line"><span class="comment"># 到GitHub下载或者直接用我给得安装包 https://github.com/etcd-io/etcd/tags，百度云https://pan.baidu.com/s/1arE2LdtAbcR80gmIQtIELw 提取码：ouy1</span></span><br><span class="line"><span class="comment">#梓涛的七牛云http://r102n3zvk.hd-bkt.clouddn.com/kubernetes/etcd/3.1.20/etcd-v3.1.20-linux-amd64.tar</span></span><br><span class="line">wget http://r102n3zvk.hd-bkt.clouddn.com/kubernetes/etcd/3.1.20/etcd-v3.1.20-linux-amd64.tar</span><br><span class="line"><span class="comment"># 这里要有一部把etcd包拉进来的操作</span></span><br><span class="line">tar -xf etcd-v3.1.20-linux-amd64.tar -C /opt</span><br><span class="line"><span class="built_in">cd</span> /opt</span><br><span class="line">mv etcd-v3.1.20-linux-amd64/ etcd-v3.1.20</span><br><span class="line">ln -s /opt/etcd-v3.1.20/ /opt/etcd</span><br><span class="line"><span class="built_in">cd</span> etcd</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@hdss7-12 opt]<span class="comment"># mv etcd-v3.1.20-linux-amd64/ etcd-v3.1.20</span></span><br><span class="line">[root@hdss7-12 opt]<span class="comment"># ln -s /opt/etcd-v3.1.20/ /opt/etcd</span></span><br><span class="line">[root@hdss7-12 opt]<span class="comment"># cd etcd</span></span><br><span class="line">[root@hdss7-12 etcd]<span class="comment"># ls</span></span><br><span class="line">out:Documentation  etcd  etcdctl  README-etcdctl.md  README.md  READMEv2-etcdctl.md</span><br><span class="line">[root@hdss7-12 etcd]<span class="comment"># </span></span><br></pre></td></tr></table></figure>



<blockquote>
<p><strong>tag</strong>：可以加入，解开备份文件内的文件</p>
<ul>
<li><strong>x</strong>：解压</li>
<li><strong>f</strong> ：使用档案名字</li>
<li><strong>-C</strong>：切换到指定的目录</li>
<li>整条命令合起来就是，把tgz文件以tgz文件名为名字解压到opt目录下，并保存tgz文件原样</li>
</ul>
<p><strong>ln</strong>：为某一个文件在另外一个位置建立一个同步的链接</p>
<ul>
<li><code>语法:ln [参数][源文件或目录][目标文件或目录]</code></li>
<li><strong>-s</strong>：软连接，可以对整个目录进行链接</li>
</ul>
<p><strong>useradd</strong>：建立用户帐号</p>
<p><strong>-s</strong>：指定用户登入后所使用的shell</p>
<p><strong>-M</strong>：不要自动建立用户的登入目录</p>
</blockquote>
<h4 id="12-21-22机器证书迁移"><a href="#12-21-22机器证书迁移" class="headerlink" title="12/21/22机器证书迁移"></a>12/21/22机器证书迁移</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p /opt/etcd/certs /data/etcd /data/logs/etcd-server</span><br><span class="line"><span class="built_in">cd</span> /opt/etcd/certs/</span><br><span class="line">scp hdss7-200.host.com:/opt/certs/ca.pem .</span><br><span class="line"><span class="comment"># 输入200虚机密码</span></span><br><span class="line">scp hdss7-200.host.com:/opt/certs/etcd-peer.pem .</span><br><span class="line">scp hdss7-200.host.com:/opt/certs/etcd-peer-key.pem .</span><br><span class="line"><span class="built_in">cd</span> ..</span><br><span class="line"><span class="comment">#我这里没用短域名，所以用的长域名，如果用了短域名可以直接scp hdss7-200:/opt/certs/ca.pem .</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@hdss7-22 opt]<span class="comment"># scp hdss7-200.host.com:/opt/certs/ca.pem .</span></span><br><span class="line">The authenticity of host <span class="string">&#x27;hdss7-200.host.com (10.4.7.200)&#x27;</span> can<span class="string">&#x27;t be established.</span></span><br><span class="line"><span class="string">ECDSA key fingerprint is SHA256:IxoM3K8wm1v9/3gGc1l3XMt7WWdRY0d99RE/c5cFaUE.</span></span><br><span class="line"><span class="string">ECDSA key fingerprint is MD5:b6:18:3f:db:63:63:b6:09:62:54:e5:aa:02:b1:4c:59.</span></span><br><span class="line"><span class="string">Are you sure you want to continue connecting (yes/no)? yes</span></span><br><span class="line"><span class="string">Warning: Permanently added &#x27;</span>hdss7-200.host.com,10.4.7.200<span class="string">&#x27; (ECDSA) to the list of known hosts.</span></span><br><span class="line"><span class="string">root@hdss7-200.host.com&#x27;</span>s password: </span><br><span class="line">ca.pem                                                                                           100% 1346     1.8MB/s   00:00    </span><br><span class="line">[root@hdss7-22 opt]<span class="comment"># scp hdss7-200.host.com:/opt/certs/etcd-peer.pem .</span></span><br><span class="line">root@hdss7-200.host.com<span class="string">&#x27;s password: </span></span><br><span class="line"><span class="string">etcd-peer.pem                                                                                    100% 1428    28.3KB/s   00:00    </span></span><br><span class="line"><span class="string">[root@hdss7-22 opt]# scp hdss7-200.host.com:/opt/certs/etcd-peer-key.pem .</span></span><br><span class="line"><span class="string">root@hdss7-200.host.com&#x27;</span>s password: </span><br><span class="line">etcd-peer-key.pem                                                                                100% 1679     2.2MB/s   00:00    </span><br><span class="line">[root@hdss7-22 opt]<span class="comment"># </span></span><br></pre></td></tr></table></figure>

<h4 id="创建etcd启动文件"><a href="#创建etcd启动文件" class="headerlink" title="创建etcd启动文件"></a>创建etcd启动文件</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"># 注意，如果是21机器，这下面得12都得改成21，initial-cluster则是全部机器都有不需要改，一共5处：etcd-server-7-12、listen-peer-urls后、client-urls后、advertise-peer-urls后、advertise-client-urls后</span><br><span class="line">vi /opt/etcd/etcd-server-startup.sh</span><br><span class="line"></span><br><span class="line">#!/bin/sh</span><br><span class="line">./etcd --name etcd-server-7-12 \</span><br><span class="line">       --data-dir /data/etcd/etcd-server \</span><br><span class="line">       --listen-peer-urls https://10.4.7.12:2380 \</span><br><span class="line">       --listen-client-urls https://10.4.7.12:2379,http://127.0.0.1:2379 \</span><br><span class="line">       --quota-backend-bytes 8000000000 \</span><br><span class="line">       --initial-advertise-peer-urls https://10.4.7.12:2380 \</span><br><span class="line">       --advertise-client-urls https://10.4.7.12:2379,http://127.0.0.1:2379 \</span><br><span class="line">       --initial-cluster  etcd-server-7-12=https://10.4.7.12:2380,etcd-server-7-21=https://10.4.7.21:2380,etcd-server-7-22=https://10.4.7.22:2380 \</span><br><span class="line">       --ca-file ./certs/ca.pem \</span><br><span class="line">       --cert-file ./certs/etcd-peer.pem \</span><br><span class="line">       --key-file ./certs/etcd-peer-key.pem \</span><br><span class="line">       --client-cert-auth  \</span><br><span class="line">       --trusted-ca-file ./certs/ca.pem \</span><br><span class="line">       --peer-ca-file ./certs/ca.pem \</span><br><span class="line">       --peer-cert-file ./certs/etcd-peer.pem \</span><br><span class="line">       --peer-key-file ./certs/etcd-peer-key.pem \</span><br><span class="line">       --peer-client-cert-auth \</span><br><span class="line">       --peer-trusted-ca-file ./certs/ca.pem \</span><br><span class="line">       --log-output stdout</span><br><span class="line"></span><br><span class="line">chmod +x etcd-server-startup.sh</span><br><span class="line">chown -R etcd.etcd /opt/etcd-v3.1.20/</span><br><span class="line">chown -R etcd.etcd /data/etcd/</span><br><span class="line">chown -R etcd.etcd /data/logs/etcd-server/</span><br><span class="line">ll</span><br></pre></td></tr></table></figure>

<blockquote>
<p><strong>scp</strong>：用于 <em>Linux</em> 之间复制文件和目录</p>
<p><strong>chmod</strong>：添加权限</p>
<ul>
<li><strong>+x</strong>：给当前用户添加可执行该文件的权限权限</li>
</ul>
<p><strong>chown</strong>：指定文件的拥有者改为指定的用户或组</p>
<ul>
<li><strong>-R</strong>：处理指定目录以及其子目录下的所有文件</li>
<li>这里即是把/opt/etcd…等的拥有者给etcd用户</li>
</ul>
<p><strong>ll</strong>：列出权限、大小、名称等信息</p>
</blockquote>
<p><img    class="lazyload" data-original="https://gitee.com/hackxu/img/raw/master/docker/202111012345374.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="   ><span class="image-caption">image-20211101234549289</span></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 12/21/22机器，我们同时需要supervisor（守护进程工具）来确保etcd是启动的，后面还会不断用到：</span></span><br><span class="line">yum install supervisor -y</span><br><span class="line">systemctl start supervisord</span><br><span class="line">systemctl <span class="built_in">enable</span> supervisord</span><br></pre></td></tr></table></figure>

<p><img    class="lazyload" data-original="https://gitee.com/hackxu/img/raw/master/docker/202111012355650.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="   ><span class="image-caption">image-20211101235232183</span></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"># 注意修改下面得7-12，对应上机器，如21机器就是7-21，一共一处：[program:etcd-server-7-12]</span><br><span class="line">vi /etc/supervisord.d/etcd-server.ini</span><br><span class="line">[program:etcd-server-7-12]</span><br><span class="line">command=/opt/etcd/etcd-server-startup.sh                        ; the program (relative uses PATH, can take args)</span><br><span class="line">numprocs=1                                                      ; number of processes copies to start (def 1)</span><br><span class="line">directory=/opt/etcd                                             ; directory to cwd to before exec (def no cwd)</span><br><span class="line">autostart=true                                                  ; start at supervisord start (default: true)</span><br><span class="line">autorestart=true                                                ; retstart at unexpected quit (default: true)</span><br><span class="line">startsecs=30                                                    ; number of secs prog must stay running (def. 1)</span><br><span class="line">startretries=3                                                  ; max # of serial start failures (default 3)</span><br><span class="line">exitcodes=0,2                                                   ; &#x27;expected&#x27; exit codes for process (default 0,2)</span><br><span class="line">stopsignal=QUIT                                                 ; signal used to kill process (default TERM)</span><br><span class="line">stopwaitsecs=10                                                 ; max num secs to wait b4 SIGKILL (default 10)</span><br><span class="line">user=etcd                                                       ; setuid to this UNIX account to run the program</span><br><span class="line">redirect_stderr=true                                            ; redirect proc stderr to stdout (default false)</span><br><span class="line">stdout_logfile=/data/logs/etcd-server/etcd.stdout.log           ; stdout log path, NONE for none; default AUTO</span><br><span class="line">stdout_logfile_maxbytes=64MB                                    ; max # logfile bytes b4 rotation (default 50MB)</span><br><span class="line">stdout_logfile_backups=4                                        ; # of stdout logfile backups (default 10)</span><br><span class="line">stdout_capture_maxbytes=1MB                                     ; number of bytes in &#x27;capturemode&#x27; (default 0)</span><br><span class="line">stdout_events_enabled=false                                     ; emit events on stdout writes (default false)</span><br><span class="line"></span><br><span class="line">supervisorctl update</span><br><span class="line"># out：etcd-server-7-21: added process group</span><br><span class="line">supervisorctl status</span><br><span class="line"># out: etcd-server-7-12                 RUNNING   pid 16582, uptime 0:00:59</span><br><span class="line">netstat -luntp|grep etcd</span><br><span class="line"># 必须是监听了2379和2380这两个端口才算成功</span><br><span class="line">#out:etcd-server-7-12: added process group</span><br></pre></td></tr></table></figure>



<p><img    class="lazyload" data-original="C:/Users/Administrator/AppData/Roaming/Typora/typora-user-images/image-20211101235500484.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="   ><span class="image-caption">image-20211101235500484</span></p>
<blockquote>
<p><strong>systemctl enable</strong>：开机启动</p>
<p><strong>update</strong>：更新</p>
<p><strong>netstat -luntp：</strong>查看端口和进程情况</p>
<p>现在你可以感觉到，supervisor守护进程也仅仅是你配好ini文件即可</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 任意节点（12/21/22）检测集群健康状态的两种方法</span></span><br><span class="line">[root@hdss7-22 etcd]<span class="comment"># ./etcdctl cluster-health</span></span><br><span class="line">[root@hdss7-22 etcd]<span class="comment"># ./etcdctl member list</span></span><br><span class="line"></span><br><span class="line">[root@hdss7-22 etcd]<span class="comment"># ./etcdctl cluster-health</span></span><br><span class="line">member 988139385f78284 is healthy: got healthy result from http://127.0.0.1:2379</span><br><span class="line">member 5a0ef2a004fc4349 is healthy: got healthy result from http://127.0.0.1:2379</span><br><span class="line">member f4a0cb0a765574a8 is unreachable: no available published client urls</span><br><span class="line">cluster is healthy</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><img    class="lazyload" data-original="https://gitee.com/hackxu/img/raw/master/docker/202111012359843.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="   ><span class="image-caption">image-20211101235906782</span></p>
<p><strong>哪台机器的isLeader=True哪台机器就是leader。</strong></p>
<p>完成</p>
<h3 id="安装API-server集群"><a href="#安装API-server集群" class="headerlink" title="安装API-server集群"></a>安装API-server集群</h3><p><strong>拓扑如下</strong></p>
<p><img    class="lazyload" data-original="https://gitee.com/hackxu/img/raw/master/docker/202111022239253.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="   ><span class="image-caption">1584701070750</span></p>
<h4 id="21-22机器安装K8S"><a href="#21-22机器安装K8S" class="headerlink" title="21\22机器安装K8S"></a><strong>21\22机器安装K8S</strong></h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#下载k8s安装包</span></span><br><span class="line">wget http://r102n3zvk.hd-bkt.clouddn.com/kubernetes/kubernetes-server/1.15.2/kubernetes-server-linux-amd64.tar.gz</span><br><span class="line"></span><br><span class="line">tar -xf kubernetes-server-linux-amd64.tar.gz -C /opt/</span><br><span class="line"><span class="built_in">cd</span> /opt/</span><br><span class="line">[root@hdss7-21 opt]<span class="comment"># tar -xf kubernetes-server-linux-amd64.tar</span></span><br><span class="line">[root@hdss7-21 opt]<span class="comment"># cd kubernetes/</span></span><br><span class="line">[root@hdss7-21 kubernetes]<span class="comment"># </span></span><br><span class="line">[root@hdss7-21 kubernetes]<span class="comment"># rm -rf kubernetes-src.tar.gz</span></span><br><span class="line">[root@hdss7-21 kubernetes]<span class="comment"># cd server/bin</span></span><br><span class="line">[root@hdss7-21 bin]<span class="comment"># rm -f *.tar</span></span><br><span class="line">[root@hdss7-21 bin]<span class="comment"># rm -f *_tag</span></span><br><span class="line">[root@hdss7-21 bin]<span class="comment"># ll</span></span><br><span class="line">out:</span><br><span class="line">-rwxr-xr-x 1 root root  43534816 8月   5 2019 apiextensions-apiserver</span><br><span class="line">-rwxr-xr-x 1 root root 100548640 8月   5 2019 cloud-controller-manager</span><br><span class="line">-rwxr-xr-x 1 root root 200648416 8月   5 2019 hyperkube</span><br><span class="line">-rwxr-xr-x 1 root root  40182208 8月   5 2019 kubeadm</span><br><span class="line">-rwxr-xr-x 1 root root 164501920 8月   5 2019 kube-apiserver</span><br><span class="line">-rwxr-xr-x 1 root root 116397088 8月   5 2019 kube-controller-manager</span><br><span class="line">-rwxr-xr-x 1 root root  42985504 8月   5 2019 kubectl</span><br><span class="line">-rwxr-xr-x 1 root root 119616640 8月   5 2019 kubelet</span><br><span class="line">-rwxr-xr-x 1 root root  36987488 8月   5 2019 kube-proxy</span><br><span class="line">-rwxr-xr-x 1 root root  38786144 8月   5 2019 kube-scheduler</span><br><span class="line">-rwxr-xr-x 1 root root   1648224 8月   5 2019 mounter</span><br></pre></td></tr></table></figure>

<blockquote>
<p><strong>tar xf -C</strong>：解压到某个文件夹</p>
<p><strong>mv</strong>：移动到哪里</p>
<p><strong>ln -s</strong>：建立软连接</p>
<p><strong>rm</strong>：删除一个文件或者目录</p>
<ul>
<li><strong>-r</strong>：将目录及以下之档案亦逐一删除</li>
<li><strong>-f</strong>：直接删除，无需逐一确认（你可以试试先不加-f去删除）</li>
<li>加起来就是强制删除</li>
</ul>
<p><em><strong>.tar</strong>： 这里的</em>的意思是模糊法，即只要你的结尾是.tar的都匹配上加上rm，就是把所有.tar结尾的文件都删除</p>
</blockquote>
<h4 id="签发client证书"><a href="#签发client证书" class="headerlink" title="签发client证书"></a>签发client证书</h4><p><strong>运维主机hdss-200.host.com上</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-200 ~]<span class="comment"># cd /opt/certs</span></span><br><span class="line"></span><br><span class="line">[root@hdss7-200 certs]vi client-csr.json</span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">&quot;CN&quot;</span>: <span class="string">&quot;k8s-node&quot;</span>,</span><br><span class="line">    <span class="string">&quot;hosts&quot;</span>: [</span><br><span class="line">    ],</span><br><span class="line">    <span class="string">&quot;key&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;algo&quot;</span>: <span class="string">&quot;rsa&quot;</span>,</span><br><span class="line">        <span class="string">&quot;size&quot;</span>: 2048</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">&quot;names&quot;</span>: [</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="string">&quot;C&quot;</span>: <span class="string">&quot;CN&quot;</span>,</span><br><span class="line">            <span class="string">&quot;ST&quot;</span>: <span class="string">&quot;beijing&quot;</span>,</span><br><span class="line">            <span class="string">&quot;L&quot;</span>: <span class="string">&quot;beijing&quot;</span>,</span><br><span class="line">            <span class="string">&quot;O&quot;</span>: <span class="string">&quot;od&quot;</span>,</span><br><span class="line">            <span class="string">&quot;OU&quot;</span>: <span class="string">&quot;ops&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">[root@hdss7-200 certs]cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=client client-csr.json |cfssl-json -bare client</span><br></pre></td></tr></table></figure>

<p><img    class="lazyload" data-original="https://gitee.com/hackxu/img/raw/master/docker/202111022324686.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="   ><span class="image-caption">image-20211102232443627</span></p>
<h4 id="API-server做证书-200机器"><a href="#API-server做证书-200机器" class="headerlink" title="API-server做证书-200机器"></a>API-server做证书-200机器</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-200 ~]<span class="comment"># cd /opt/certs</span></span><br><span class="line"></span><br><span class="line">[root@hdss7-200 certs]vi apiserver-csr.json</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">&quot;CN&quot;</span>: <span class="string">&quot;k8s-apiserver&quot;</span>,</span><br><span class="line">    <span class="string">&quot;hosts&quot;</span>: [</span><br><span class="line">        <span class="string">&quot;127.0.0.1&quot;</span>,</span><br><span class="line">        <span class="string">&quot;192.168.0.1&quot;</span>,</span><br><span class="line">        <span class="string">&quot;kubernetes&quot;</span>,</span><br><span class="line">        <span class="string">&quot;kubernetes.default&quot;</span>,</span><br><span class="line">        <span class="string">&quot;kubernetes.default.svc&quot;</span>,</span><br><span class="line">        <span class="string">&quot;kubernetes.default.svc.cluster&quot;</span>,</span><br><span class="line">        <span class="string">&quot;kubernetes.default.svc.cluster.local&quot;</span>,</span><br><span class="line">        <span class="string">&quot;10.4.7.10&quot;</span>,</span><br><span class="line">        <span class="string">&quot;10.4.7.21&quot;</span>,</span><br><span class="line">        <span class="string">&quot;10.4.7.22&quot;</span>,</span><br><span class="line">        <span class="string">&quot;10.4.7.23&quot;</span></span><br><span class="line">    ],</span><br><span class="line">    <span class="string">&quot;key&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;algo&quot;</span>: <span class="string">&quot;rsa&quot;</span>,</span><br><span class="line">        <span class="string">&quot;size&quot;</span>: 2048</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">&quot;names&quot;</span>: [</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="string">&quot;C&quot;</span>: <span class="string">&quot;CN&quot;</span>,</span><br><span class="line">            <span class="string">&quot;ST&quot;</span>: <span class="string">&quot;beijing&quot;</span>,</span><br><span class="line">            <span class="string">&quot;L&quot;</span>: <span class="string">&quot;beijing&quot;</span>,</span><br><span class="line">            <span class="string">&quot;O&quot;</span>: <span class="string">&quot;od&quot;</span>,</span><br><span class="line">            <span class="string">&quot;OU&quot;</span>: <span class="string">&quot;ops&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">[root@hdss7-200 ~]<span class="comment"># cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=server apiserver-csr.json |cfssl-json -bare apiserver</span></span><br><span class="line">[root@hdss7-200 ~]<span class="comment"># ll</span></span><br></pre></td></tr></table></figure>

<p><img    class="lazyload" data-original="https://gitee.com/hackxu/img/raw/master/docker/202111022327870.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="   ><span class="image-caption">image-20211102232703786</span></p>
<h4 id="21-22拷贝证书"><a href="#21-22拷贝证书" class="headerlink" title="21/22拷贝证书"></a>21/22拷贝证书</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 21/22机器：</span></span><br><span class="line"><span class="built_in">cd</span> /opt/kubernetes/server/bin</span><br><span class="line">[root@hdss7-21 bin]<span class="comment"># mkdir cert</span></span><br><span class="line">[root@hdss7-21 bin]<span class="comment"># cd cert/</span></span><br><span class="line"><span class="comment"># 把证书考过来</span></span><br><span class="line">[root@hdss7-21 cert]<span class="comment"># scp hdss7-200.host.com:/opt/certs/ca.pem .</span></span><br><span class="line">[root@hdss7-21 cert]<span class="comment"># scp hdss7-200.host.com:/opt/certs/ca-key.pem .</span></span><br><span class="line">[root@hdss7-21 cert]<span class="comment"># scp hdss7-200.host.com:/opt/certs/client-key.pem .</span></span><br><span class="line">[root@hdss7-21 cert]<span class="comment"># scp hdss7-200.host.com:/opt/certs/client.pem .</span></span><br><span class="line">[root@hdss7-21 cert]<span class="comment"># scp hdss7-200.host.com:/opt/certs/apiserver.pem .</span></span><br><span class="line">[root@hdss7-21 cert]<span class="comment"># scp hdss7-200.host.com:/opt/certs/apiserver-key.pem .</span></span><br></pre></td></tr></table></figure>

<p>21/22主机每台有6个证书</p>
<p><img    class="lazyload" data-original="https://gitee.com/hackxu/img/raw/master/docker/202111022335705.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="   ><span class="image-caption">image-20211102233540648</span></p>
<h4 id="21-22机器创建配置"><a href="#21-22机器创建配置" class="headerlink" title="21/22机器创建配置"></a>21/22机器创建配置</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /opt/kubernetes/server/bin</span><br><span class="line">mkdir conf</span><br><span class="line"><span class="built_in">cd</span> conf</span><br><span class="line">[root@hdss7-21 conf]<span class="comment"># vi audit.yaml</span></span><br><span class="line"></span><br><span class="line">apiVersion: audit.k8s.io/v1beta1 <span class="comment"># This is required.</span></span><br><span class="line">kind: Policy</span><br><span class="line"><span class="comment"># Don&#x27;t generate audit events for all requests in RequestReceived stage.</span></span><br><span class="line">omitStages:</span><br><span class="line">  - <span class="string">&quot;RequestReceived&quot;</span></span><br><span class="line">rules:</span><br><span class="line">  <span class="comment"># Log pod changes at RequestResponse level</span></span><br><span class="line">  - level: RequestResponse</span><br><span class="line">    resources:</span><br><span class="line">    - group: <span class="string">&quot;&quot;</span></span><br><span class="line">      <span class="comment"># Resource &quot;pods&quot; doesn&#x27;t match requests to any subresource of pods,</span></span><br><span class="line">      <span class="comment"># which is consistent with the RBAC policy.</span></span><br><span class="line">      resources: [<span class="string">&quot;pods&quot;</span>]</span><br><span class="line">  <span class="comment"># Log &quot;pods/log&quot;, &quot;pods/status&quot; at Metadata level</span></span><br><span class="line">  - level: Metadata</span><br><span class="line">    resources:</span><br><span class="line">    - group: <span class="string">&quot;&quot;</span></span><br><span class="line">      resources: [<span class="string">&quot;pods/log&quot;</span>, <span class="string">&quot;pods/status&quot;</span>]</span><br><span class="line"></span><br><span class="line">  <span class="comment"># Don&#x27;t log requests to a configmap called &quot;controller-leader&quot;</span></span><br><span class="line">  - level: None</span><br><span class="line">    resources:</span><br><span class="line">    - group: <span class="string">&quot;&quot;</span></span><br><span class="line">      resources: [<span class="string">&quot;configmaps&quot;</span>]</span><br><span class="line">      resourceNames: [<span class="string">&quot;controller-leader&quot;</span>]</span><br><span class="line"></span><br><span class="line">  <span class="comment"># Don&#x27;t log watch requests by the &quot;system:kube-proxy&quot; on endpoints or services</span></span><br><span class="line">  - level: None</span><br><span class="line">    users: [<span class="string">&quot;system:kube-proxy&quot;</span>]</span><br><span class="line">    verbs: [<span class="string">&quot;watch&quot;</span>]</span><br><span class="line">    resources:</span><br><span class="line">    - group: <span class="string">&quot;&quot;</span> <span class="comment"># core API group</span></span><br><span class="line">      resources: [<span class="string">&quot;endpoints&quot;</span>, <span class="string">&quot;services&quot;</span>]</span><br><span class="line"></span><br><span class="line">  <span class="comment"># Don&#x27;t log authenticated requests to certain non-resource URL paths.</span></span><br><span class="line">  - level: None</span><br><span class="line">    userGroups: [<span class="string">&quot;system:authenticated&quot;</span>]</span><br><span class="line">    nonResourceURLs:</span><br><span class="line">    - <span class="string">&quot;/api*&quot;</span> <span class="comment"># Wildcard matching.</span></span><br><span class="line">    - <span class="string">&quot;/version&quot;</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># Log the request body of configmap changes in kube-system.</span></span><br><span class="line">  - level: Request</span><br><span class="line">    resources:</span><br><span class="line">    - group: <span class="string">&quot;&quot;</span> <span class="comment"># core API group</span></span><br><span class="line">      resources: [<span class="string">&quot;configmaps&quot;</span>]</span><br><span class="line">    <span class="comment"># This rule only applies to resources in the &quot;kube-system&quot; namespace.</span></span><br><span class="line">    <span class="comment"># The empty string &quot;&quot; can be used to select non-namespaced resources.</span></span><br><span class="line">    namespaces: [<span class="string">&quot;kube-system&quot;</span>]</span><br><span class="line"></span><br><span class="line">  <span class="comment"># Log configmap and secret changes in all other namespaces at the Metadata level.</span></span><br><span class="line">  - level: Metadata</span><br><span class="line">    resources:</span><br><span class="line">    - group: <span class="string">&quot;&quot;</span> <span class="comment"># core API group</span></span><br><span class="line">      resources: [<span class="string">&quot;secrets&quot;</span>, <span class="string">&quot;configmaps&quot;</span>]</span><br><span class="line"></span><br><span class="line">  <span class="comment"># Log all other resources in core and extensions at the Request level.</span></span><br><span class="line">  - level: Request</span><br><span class="line">    resources:</span><br><span class="line">    - group: <span class="string">&quot;&quot;</span> <span class="comment"># core API group</span></span><br><span class="line">    - group: <span class="string">&quot;extensions&quot;</span> <span class="comment"># Version of group should NOT be included.</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># A catch-all rule to log all other requests at the Metadata level.</span></span><br><span class="line">  - level: Metadata</span><br><span class="line">    <span class="comment"># Long-running requests like watches that fall under this rule will not</span></span><br><span class="line">    <span class="comment"># generate an audit event in RequestReceived.</span></span><br><span class="line">    omitStages:</span><br><span class="line">      - <span class="string">&quot;RequestReceived&quot;</span></span><br><span class="line">      </span><br><span class="line">[root@hdss7-21 conf]<span class="comment"># cd ..</span></span><br><span class="line">[root@hdss7-21 bin]<span class="comment"># vi /opt/kubernetes/server/bin/kube-apiserver.sh</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#!/bin/bash</span></span><br><span class="line">./kube-apiserver \</span><br><span class="line">  --apiserver-count 2 \</span><br><span class="line">  --audit-log-path /data/logs/kubernetes/kube-apiserver/audit-log \</span><br><span class="line">  --audit-policy-file ./conf/audit.yaml \</span><br><span class="line">  --authorization-mode RBAC \</span><br><span class="line">  --client-ca-file ./cert/ca.pem \</span><br><span class="line">  --requestheader-client-ca-file ./cert/ca.pem \</span><br><span class="line">  --enable-admission-plugins NamespaceLifecycle,LimitRanger,ServiceAccount,DefaultStorageClass,DefaultTolerationSeconds,MutatingAdmissionWebhook,ValidatingAdmissionWebhook,ResourceQuota \</span><br><span class="line">  --etcd-cafile ./cert/ca.pem \</span><br><span class="line">  --etcd-certfile ./cert/client.pem \</span><br><span class="line">  --etcd-keyfile ./cert/client-key.pem \</span><br><span class="line">  --etcd-servers https://10.4.7.12:2379,https://10.4.7.21:2379,https://10.4.7.22:2379 \</span><br><span class="line">  --service-account-key-file ./cert/ca-key.pem \</span><br><span class="line">  --service-cluster-ip-range 192.168.0.0/16 \</span><br><span class="line">  --service-node-port-range 3000-29999 \</span><br><span class="line">  --target-ram-mb=1024 \</span><br><span class="line">  --kubelet-client-certificate ./cert/client.pem \</span><br><span class="line">  --kubelet-client-key ./cert/client-key.pem \</span><br><span class="line">  --log-dir  /data/logs/kubernetes/kube-apiserver \</span><br><span class="line">  --tls-cert-file ./cert/apiserver.pem \</span><br><span class="line">  --tls-private-key-file ./cert/apiserver-key.pem \</span><br><span class="line">  --v 2</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@hdss7-21 bin]<span class="comment"># chmod +x kube-apiserver.sh</span></span><br><span class="line"><span class="comment">#一处需要修改的地方： [program:kube-apiserver-7-21]（22机器改为7-22）  </span></span><br><span class="line">[root@hdss7-21 bin]<span class="comment"># vi /etc/supervisord.d/kube-apiserver.ini</span></span><br><span class="line">[program:kube-apiserver-7-21]</span><br><span class="line"><span class="built_in">command</span>=/opt/kubernetes/server/bin/kube-apiserver.sh            ; the program (relative uses PATH, can take args)</span><br><span class="line">numprocs=1                                                      ; number of processes copies to start (def 1)</span><br><span class="line">directory=/opt/kubernetes/server/bin                            ; directory to cwd to before <span class="built_in">exec</span> (def no cwd)</span><br><span class="line">autostart=<span class="literal">true</span>                                                  ; start at supervisord start (default: <span class="literal">true</span>)</span><br><span class="line">autorestart=<span class="literal">true</span>                                                ; retstart at unexpected quit (default: <span class="literal">true</span>)</span><br><span class="line">startsecs=30                                                    ; number of secs prog must stay running (def. 1)</span><br><span class="line">startretries=3                                                  ; max <span class="comment"># of serial start failures (default 3)</span></span><br><span class="line">exitcodes=0,2                                                   ; <span class="string">&#x27;expected&#x27;</span> <span class="built_in">exit</span> codes <span class="keyword">for</span> process (default 0,2)</span><br><span class="line">stopsignal=QUIT                                                 ; signal used to <span class="built_in">kill</span> process (default TERM)</span><br><span class="line">stopwaitsecs=10                                                 ; max num secs to <span class="built_in">wait</span> b4 SIGKILL (default 10)</span><br><span class="line">user=root                                                       ; setuid to this UNIX account to run the program</span><br><span class="line">redirect_stderr=<span class="literal">true</span>                                            ; redirect proc stderr to stdout (default <span class="literal">false</span>)</span><br><span class="line">stdout_logfile=/data/logs/kubernetes/kube-apiserver/apiserver.stdout.log        ; stderr <span class="built_in">log</span> path, NONE <span class="keyword">for</span> none; default AUTO</span><br><span class="line">stdout_logfile_maxbytes=64MB                                    ; max <span class="comment"># logfile bytes b4 rotation (default 50MB)</span></span><br><span class="line">stdout_logfile_backups=4                                        ; <span class="comment"># of stdout logfile backups (default 10)</span></span><br><span class="line">stdout_capture_maxbytes=1MB                                     ; number of bytes <span class="keyword">in</span> <span class="string">&#x27;capturemode&#x27;</span> (default 0)</span><br><span class="line">stdout_events_enabled=<span class="literal">false</span>                                     ; emit events on stdout writes (default <span class="literal">false</span>)</span><br><span class="line">[root@hdss7-21 bin]<span class="comment"># mkdir -p /data/logs/kubernetes/kube-apiserver</span></span><br><span class="line">[root@hdss7-21 bin]<span class="comment"># supervisorctl update</span></span><br><span class="line">out:kube-apiserver-7-21: added process group</span><br><span class="line"><span class="comment"># 查看21/22两台机器是否跑起来了，可能比较慢在starting，等10秒</span></span><br><span class="line">[root@hdss7-21 bin]<span class="comment"># supervisorctl status</span></span><br></pre></td></tr></table></figure>

<p><img    class="lazyload" data-original="https://gitee.com/hackxu/img/raw/master/docker/202111022352598.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="   ><span class="image-caption">image-20211102235203541</span></p>
<blockquote>
<p><strong>mkdir -p</strong>：创建目录，没有上一级目录则创建</p>
<p><strong>supervisorctl update</strong>：更新supervisorctl</p>
<p><strong>audit.yaml解析：</strong></p>
<ul>
<li>可以参考这篇文章<a target="_blank" rel="noopener" href="https://www.baidu.com/link?url=tFECOG31lKlcqDWeAZGF1VyjhzVAN9vUKHKEKKw5G8y0AC8MKpJxSZeL647MIFdw&wd=&eqid=dafe84b80019e4a3000000065e51d2e2">点击跳转</a>，当然这里的audit.yaml可能会有些不一样，但是我们后面用到的yaml文件就很相似了</li>
</ul>
<p><a target="_blank" rel="noopener" href="https://github.com/ben1234560/k8s_PaaS/blob/master/%E5%8E%9F%E7%90%86%E5%8F%8A%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/Kubernetes%E5%9F%BA%E6%9C%AC%E6%A6%82%E5%BF%B5.md#pod%E7%9A%84%E5%87%A0%E7%A7%8D%E7%8A%B6%E6%80%81">Pod的几种状态</a></p>
</blockquote>
<p>完成</p>
<h3 id="安装部署主控节点L4反代服务"><a href="#安装部署主控节点L4反代服务" class="headerlink" title="安装部署主控节点L4反代服务"></a>安装部署主控节点L4反代服务</h3><p><img    class="lazyload" data-original="https://gitee.com/hackxu/img/raw/master/docker/202111112254785.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="   ><span class="image-caption">1584701103579</span></p>
<p>根据架构图，在11/12机器上做反代</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"># 11/12机器</span><br><span class="line">~]#yum install nginx -y</span><br><span class="line"># 添加在最下面</span><br><span class="line">~]# vi /etc/nginx/nginx.conf</span><br><span class="line">stream &#123;</span><br><span class="line">    upstream kube-apiserver &#123;</span><br><span class="line">        server 10.4.7.21:6443     max_fails=3 fail_timeout=30s;</span><br><span class="line">        server 10.4.7.22:6443     max_fails=3 fail_timeout=30s;</span><br><span class="line">    &#125;</span><br><span class="line">    server &#123;</span><br><span class="line">        listen 7443;</span><br><span class="line">        proxy_connect_timeout 2s;</span><br><span class="line">        proxy_timeout 900s;</span><br><span class="line">        proxy_pass kube-apiserver;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">~]# nginx -t</span><br><span class="line"># 报错了执行这个命令</span><br><span class="line">yum -y install nginx-all-modules.noarch</span><br><span class="line"></span><br><span class="line">~]# systemctl start nginx</span><br><span class="line">~]# systemctl enable nginx</span><br><span class="line">~]# yum install keepalived -y</span><br><span class="line"># keepalived 监控端口脚本</span><br><span class="line">~]# vi /etc/keepalived/check_port.sh</span><br><span class="line">#!/bin/bash</span><br><span class="line">CHK_PORT=$1</span><br><span class="line">if [ -n &quot;$CHK_PORT&quot; ];then</span><br><span class="line">        PORT_PROCESS=`ss -lnt|grep $CHK_PORT|wc -l`</span><br><span class="line">        if [ $PORT_PROCESS -eq 0 ];then</span><br><span class="line">                echo &quot;Port $CHK_PORT Is Not Used,End.&quot;</span><br><span class="line">                exit 1</span><br><span class="line">        fi</span><br><span class="line">else</span><br><span class="line">        echo &quot;Check Port Cant Be Empty!&quot;</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line">~]# chmod +x /etc/keepalived/check_port.sh</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line"># 仅以下分主从操作：</span><br><span class="line"># 把原有内容都删掉，命令行快速按打出dG</span><br><span class="line"># 注意，下面的vrrp_instance下的interface，我的机器是eth0配置了网卡，有的版本是ens33配置网卡，可以用ifconfig查看，第一行就是，如果你是ens33，改这个interface ens33</span><br><span class="line"># keepalived 主（即11机器）:</span><br><span class="line">11 ~]# vi /etc/keepalived/keepalived.conf</span><br><span class="line">! Configuration File for keepalived</span><br><span class="line"></span><br><span class="line">global_defs &#123;</span><br><span class="line">   router_id 10.4.7.11</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">vrrp_script chk_nginx &#123;</span><br><span class="line">    script &quot;/etc/keepalived/check_port.sh 7443&quot;</span><br><span class="line">    interval 2</span><br><span class="line">    weight -20</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">vrrp_instance VI_1 &#123;</span><br><span class="line">    state MASTER</span><br><span class="line">    interface eth0</span><br><span class="line">    virtual_router_id 251</span><br><span class="line">    priority 100</span><br><span class="line">    advert_int 1</span><br><span class="line">    mcast_src_ip 10.4.7.11</span><br><span class="line">    nopreempt</span><br><span class="line"></span><br><span class="line">    authentication &#123;</span><br><span class="line">        auth_type PASS</span><br><span class="line">        auth_pass 11111111</span><br><span class="line">    &#125;</span><br><span class="line">    track_script &#123;</span><br><span class="line">         chk_nginx</span><br><span class="line">    &#125;</span><br><span class="line">    virtual_ipaddress &#123;</span><br><span class="line">        10.4.7.10</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">keepalived从（即12机器）:</span><br><span class="line">12 ~]# vi /etc/keepalived/keepalived.conf</span><br><span class="line">! Configuration File for keepalived</span><br><span class="line">global_defs &#123;</span><br><span class="line">	router_id 10.4.7.12</span><br><span class="line">&#125;</span><br><span class="line">vrrp_script chk_nginx &#123;</span><br><span class="line">	script &quot;/etc/keepalived/check_port.sh 7443&quot;</span><br><span class="line">	interval 2</span><br><span class="line">	weight -20</span><br><span class="line">&#125;</span><br><span class="line">vrrp_instance VI_1 &#123;</span><br><span class="line">	state BACKUP</span><br><span class="line">	interface ens33</span><br><span class="line">	virtual_router_id 251</span><br><span class="line">	mcast_src_ip 10.4.7.12</span><br><span class="line">	priority 90</span><br><span class="line">	advert_int 1</span><br><span class="line">	authentication &#123;</span><br><span class="line">		auth_type PASS</span><br><span class="line">		auth_pass 11111111</span><br><span class="line">	&#125;</span><br><span class="line">	track_script &#123;</span><br><span class="line">		chk_nginx</span><br><span class="line">	&#125;</span><br><span class="line">	virtual_ipaddress &#123;</span><br><span class="line">		10.4.7.10</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"># 11/12机器</span><br><span class="line">~]# systemctl start keepalived</span><br><span class="line">~]# systemctl enable keepalived</span><br><span class="line"># 在11机器</span><br><span class="line">11 ~]# ip add</span><br></pre></td></tr></table></figure>

<p><img    class="lazyload" data-original="https://gitee.com/ginohuang/k8s-paas/raw/master/assets/1578840833339.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="   ><span class="image-caption">1578840833339</span></p>
<h4 id="小实验（可不做）："><a href="#小实验（可不做）：" class="headerlink" title="小实验（可不做）："></a>小实验（可不做）：</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># 实验(可不做)：在11机器关掉nginx</span><br><span class="line">11 ~]# nginx -s stop</span><br><span class="line">11 ~]# netstat -luntp|grep 7443</span><br><span class="line"># 代理会跑到12机器</span><br></pre></td></tr></table></figure>

<p><img    class="lazyload" data-original="https://gitee.com/hackxu/img/raw/master/docker/202111112303642.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="   ><span class="image-caption">1578841077321</span></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">11 ~]# nginx</span><br><span class="line">11 ~]# netstat -luntp|grep 744</span><br><span class="line"># 再起来，但也不会跑回来，因为我们配置了</span><br></pre></td></tr></table></figure>

<p><img    class="lazyload" data-original="https://gitee.com/ginohuang/k8s-paas/raw/master/assets/1578841192980.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="   ><span class="image-caption">1578841192980</span></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># 11/12机器执行：</span><br><span class="line">~]# systemctl restart keepalived</span><br><span class="line"># 11机器：</span><br><span class="line">~]# ip add</span><br></pre></td></tr></table></figure>

<blockquote>
<p>生产中，人工确定机器没问题了，再手动回来</p>
</blockquote>
<p><img    class="lazyload" data-original="https://gitee.com/ginohuang/k8s-paas/raw/master/assets/1578841301006.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="   ><span class="image-caption">1578841301006</span></p>
<p>完成</p>
<h3 id="安装部署controller-manager（节点控制器-调度器服务）"><a href="#安装部署controller-manager（节点控制器-调度器服务）" class="headerlink" title="安装部署controller-manager（节点控制器/调度器服务）"></a>安装部署controller-manager（节点控制器/调度器服务）</h3><p>让我们再搬出我们的架构图</p>
<p><img    class="lazyload" data-original="https://gitee.com/hackxu/img/raw/master/docker/202111112303725.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="   ><span class="image-caption">1584701137068</span></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line"># 21/22机器：</span><br><span class="line">bin]# vi /opt/kubernetes/server/bin/kube-controller-manager.sh</span><br><span class="line">#!/bin/sh</span><br><span class="line">./kube-controller-manager \</span><br><span class="line">  --cluster-cidr 172.7.0.0/16 \</span><br><span class="line">  --leader-elect true \</span><br><span class="line">  --log-dir /data/logs/kubernetes/kube-controller-manager \</span><br><span class="line">  --master http://127.0.0.1:8080 \</span><br><span class="line">  --service-account-private-key-file ./cert/ca-key.pem \</span><br><span class="line">  --service-cluster-ip-range 192.168.0.0/16 \</span><br><span class="line">  --root-ca-file ./cert/ca.pem \</span><br><span class="line">  --v 2</span><br><span class="line"></span><br><span class="line">bin]# chmod +x /opt/kubernetes/server/bin/kube-controller-manager.sh</span><br><span class="line">bin]# mkdir -p /data/logs/kubernetes/kube-controller-manager</span><br><span class="line"># 注意22机器，下面要改成7-22，一处修改：manager-7-21]</span><br><span class="line">bin]# vi /etc/supervisord.d/kube-conntroller-manager.ini</span><br><span class="line">[program:kube-controller-manager-7-21]</span><br><span class="line">command=/opt/kubernetes/server/bin/kube-controller-manager.sh                     ; the program (relative uses PATH, can take args)</span><br><span class="line">numprocs=1                                                                        ; number of processes copies to start (def 1)</span><br><span class="line">directory=/opt/kubernetes/server/bin                                              ; directory to cwd to before exec (def no cwd)</span><br><span class="line">autostart=true                                                                    ; start at supervisord start (default: true)</span><br><span class="line">autorestart=true                                                                  ; retstart at unexpected quit (default: true)</span><br><span class="line">startsecs=30                                                                      ; number of secs prog must stay running (def. 1)</span><br><span class="line">startretries=3                                                                    ; max # of serial start failures (default 3)</span><br><span class="line">exitcodes=0,2                                                                     ; &#x27;expected&#x27; exit codes for process (default 0,2)</span><br><span class="line">stopsignal=QUIT                                                                   ; signal used to kill process (default TERM)</span><br><span class="line">stopwaitsecs=10                                                                   ; max num secs to wait b4 SIGKILL (default 10)</span><br><span class="line">user=root                                                                         ; setuid to this UNIX account to run the program</span><br><span class="line">redirect_stderr=true                                                              ; redirect proc stderr to stdout (default false)</span><br><span class="line">stdout_logfile=/data/logs/kubernetes/kube-controller-manager/controller.stdout.log  ; stderr log path, NONE for none; default AUTO</span><br><span class="line">stdout_logfile_maxbytes=64MB                                                      ; max # logfile bytes b4 rotation (default 50MB)</span><br><span class="line">stdout_logfile_backups=4                                                          ; # of stdout logfile backups (default 10)</span><br><span class="line">stdout_capture_maxbytes=1MB                                                       ; number of bytes in &#x27;capturemode&#x27; (default 0)</span><br><span class="line">stdout_events_enabled=false                                                       ; emit events on stdout writes (default false)</span><br><span class="line"></span><br><span class="line">bin]# supervisorctl update</span><br><span class="line">bin]# vi /opt/kubernetes/server/bin/kube-scheduler.sh</span><br><span class="line">#!/bin/sh</span><br><span class="line">./kube-scheduler \</span><br><span class="line">  --leader-elect  \</span><br><span class="line">  --log-dir /data/logs/kubernetes/kube-scheduler \</span><br><span class="line">  --master http://127.0.0.1:8080 \</span><br><span class="line">  --v 2</span><br><span class="line">  </span><br><span class="line">bin]# chmod +x /opt/kubernetes/server/bin/kube-scheduler.sh</span><br><span class="line">bin]# mkdir -p /data/logs/kubernetes/kube-scheduler</span><br><span class="line"># 注意改机器号，一处修改：scheduler-7-21]</span><br><span class="line">bin]# vi /etc/supervisord.d/kube-scheduler.ini</span><br><span class="line">[program:kube-scheduler-7-21]</span><br><span class="line">command=/opt/kubernetes/server/bin/kube-scheduler.sh                     ; the program (relative uses PATH, can take args)</span><br><span class="line">numprocs=1                                                               ; number of processes copies to start (def 1)</span><br><span class="line">directory=/opt/kubernetes/server/bin                                     ; directory to cwd to before exec (def no cwd)</span><br><span class="line">autostart=true                                                           ; start at supervisord start (default: true)</span><br><span class="line">autorestart=true                                                         ; retstart at unexpected quit (default: true)</span><br><span class="line">startsecs=30                                                             ; number of secs prog must stay running (def. 1)</span><br><span class="line">startretries=3                                                           ; max # of serial start failures (default 3)</span><br><span class="line">exitcodes=0,2                                                            ; &#x27;expected&#x27; exit codes for process (default 0,2)</span><br><span class="line">stopsignal=QUIT                                                          ; signal used to kill process (default TERM)</span><br><span class="line">stopwaitsecs=10                                                          ; max num secs to wait b4 SIGKILL (default 10)</span><br><span class="line">user=root                                                                ; setuid to this UNIX account to run the program</span><br><span class="line">redirect_stderr=true                                                     ; redirect proc stderr to stdout (default false)</span><br><span class="line">stdout_logfile=/data/logs/kubernetes/kube-scheduler/scheduler.stdout.log ; stderr log path, NONE for none; default AUTO</span><br><span class="line">stdout_logfile_maxbytes=64MB                                             ; max # logfile bytes b4 rotation (default 50MB)</span><br><span class="line">stdout_logfile_backups=4                                                 ; # of stdout logfile backups (default 10)</span><br><span class="line">stdout_capture_maxbytes=1MB                                              ; number of bytes in &#x27;capturemode&#x27; (default 0)</span><br><span class="line">stdout_events_enabled=false                                              ; emit events on stdout writes (default false)</span><br><span class="line"></span><br><span class="line">bin]# supervisorctl update</span><br><span class="line">bin]# supervisorctl status</span><br><span class="line"># 起来了4个</span><br><span class="line">bin]# ln -s /opt/kubernetes/server/bin/kubectl /usr/bin/kubectl</span><br><span class="line"># 查看集群健康情况，21/22机器：</span><br><span class="line">bin]# kubectl get cs</span><br></pre></td></tr></table></figure>

<blockquote>
<p><strong>ln -s</strong>：建立软链接</p>
<p><strong>supervisorctl status</strong>：查看supervisor的情况</p>
<p><strong>supervisorctl update</strong>：更新supervisor</p>
<p><strong>kubectl get</strong>：获取列出一个或多个资源的信息</p>
<ul>
<li>上面一条命令的意思是： 列出所有cs信息</li>
</ul>
</blockquote>
<p><img    class="lazyload" data-original="https://gitee.com/hackxu/img/raw/master/docker/202111201511867.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="   ><span class="image-caption">image-20211120151125071</span></p>
<p>完成</p>
<h3 id="安装部署运算节点服务（kubelet）"><a href="#安装部署运算节点服务（kubelet）" class="headerlink" title="安装部署运算节点服务（kubelet）"></a>安装部署运算节点服务（kubelet）</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"># 签发证书，200机器</span><br><span class="line">200 certs]# cd /opt/certs</span><br><span class="line">200 certs]# vi kubelet-csr.json</span><br><span class="line">&#123;</span><br><span class="line">    &quot;CN&quot;: &quot;k8s-kubelet&quot;,</span><br><span class="line">    &quot;hosts&quot;: [</span><br><span class="line">    &quot;127.0.0.1&quot;,</span><br><span class="line">    &quot;10.4.7.10&quot;,</span><br><span class="line">    &quot;10.4.7.21&quot;,</span><br><span class="line">    &quot;10.4.7.22&quot;,</span><br><span class="line">    &quot;10.4.7.23&quot;,</span><br><span class="line">    &quot;10.4.7.24&quot;,</span><br><span class="line">    &quot;10.4.7.25&quot;,</span><br><span class="line">    &quot;10.4.7.26&quot;,</span><br><span class="line">    &quot;10.4.7.27&quot;,</span><br><span class="line">    &quot;10.4.7.28&quot;</span><br><span class="line">    ],</span><br><span class="line">    &quot;key&quot;: &#123;</span><br><span class="line">        &quot;algo&quot;: &quot;rsa&quot;,</span><br><span class="line">        &quot;size&quot;: 2048</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;names&quot;: [</span><br><span class="line">        &#123;</span><br><span class="line">            &quot;C&quot;: &quot;CN&quot;,</span><br><span class="line">            &quot;ST&quot;: &quot;beijing&quot;,</span><br><span class="line">            &quot;L&quot;: &quot;beijing&quot;,</span><br><span class="line">            &quot;O&quot;: &quot;od&quot;,</span><br><span class="line">            &quot;OU&quot;: &quot;ops&quot;</span><br><span class="line">        &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">200 certs]# cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=server kubelet-csr.json | cfssl-json -bare kubelet</span><br><span class="line">200 certs]# ll</span><br></pre></td></tr></table></figure>

<blockquote>
<p><strong>kubelet-csr-hosts</strong>：把所有可能用到的IP都放进来</p>
</blockquote>
<p><img    class="lazyload" data-original="https://gitee.com/hackxu/img/raw/master/docker/202111201516287.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="   ><span class="image-caption">image-20211120151608215</span></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"># 分发证书，21/22机器</span><br><span class="line">cert]# cd /opt/kubernetes/server/bin/cert/</span><br><span class="line">cert]# scp hdss7-200.host.com:/opt/certs/kubelet.pem .</span><br><span class="line">cert]# scp hdss7-200.host.com:/opt/certs/kubelet-key.pem .</span><br><span class="line"></span><br><span class="line"># 21机器：</span><br><span class="line">cert]# cd ../conf/</span><br><span class="line">conf]# kubectl config set-cluster myk8s \</span><br><span class="line">  --certificate-authority=/opt/kubernetes/server/bin/cert/ca.pem \</span><br><span class="line">  --embed-certs=true \</span><br><span class="line">  --server=https://10.4.7.10:7443 \</span><br><span class="line">  --kubeconfig=kubelet.kubeconfig</span><br><span class="line"></span><br><span class="line">conf]# kubectl config set-credentials k8s-node \</span><br><span class="line">  --client-certificate=/opt/kubernetes/server/bin/cert/client.pem \</span><br><span class="line">  --client-key=/opt/kubernetes/server/bin/cert/client-key.pem \</span><br><span class="line">  --embed-certs=true \</span><br><span class="line">  --kubeconfig=kubelet.kubeconfig </span><br><span class="line"></span><br><span class="line">conf]# kubectl config set-context myk8s-context \</span><br><span class="line">  --cluster=myk8s \</span><br><span class="line">  --user=k8s-node \</span><br><span class="line">  --kubeconfig=kubelet.kubeconfig</span><br><span class="line"></span><br><span class="line">conf]# kubectl config use-context myk8s-context --kubeconfig=kubelet.kubeconfig</span><br><span class="line">#out: Switched to context &quot;myk8s-context&quot;.</span><br><span class="line"># 做权限授权，推荐文章https://www.jianshu.com/p/9991f189495f</span><br><span class="line">conf]# vi k8s-node.yaml</span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1</span><br><span class="line">kind: ClusterRoleBinding</span><br><span class="line">metadata:</span><br><span class="line">  name: k8s-node</span><br><span class="line">roleRef:</span><br><span class="line">  apiGroup: rbac.authorization.k8s.io</span><br><span class="line">  kind: ClusterRole</span><br><span class="line">  name: system:node</span><br><span class="line">subjects:</span><br><span class="line">- apiGroup: rbac.authorization.k8s.io</span><br><span class="line">  kind: User</span><br><span class="line">  name: k8s-node</span><br><span class="line">  </span><br><span class="line">conf]# kubectl create -f k8s-node.yaml</span><br><span class="line">conf]# kubectl get clusterrolebinding k8s-node -o yaml</span><br><span class="line"></span><br><span class="line"># 22机器，复制21机器即可</span><br><span class="line">cert]# cd ../conf/</span><br><span class="line">conf]# scp hdss7-21.host.com:/opt/kubernetes/server/bin/conf/kubelet.kubeconfig .</span><br></pre></td></tr></table></figure>

<blockquote>
<p><strong>scp</strong>：用于 <em>Linux</em> 之间复制文件和目录</p>
<p><strong>kubectl create -f</strong> ：通过配置文件名或stdin创建一个集群资源对象</p>
<p><strong>kubectl get … -o …</strong> ：列出Pod以及运行Pod节点信息（你可以试下不加-o和加-o的区别）</p>
</blockquote>
<p><img    class="lazyload" data-original="https://gitee.com/ginohuang/k8s-paas/raw/master/assets/1580436621354.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="   ><span class="image-caption">1580436621354</span></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># 准备pause基础镜像，200机器：</span><br><span class="line">certs]# docker pull kubernetes/pause</span><br><span class="line">certs]# docker images|grep pause</span><br><span class="line">certs]# docker tag f9d5de079539 harbor.od.com/public/pause:latest</span><br><span class="line">certs]# docker push harbor.od.com/public/pause:latest</span><br></pre></td></tr></table></figure>

<blockquote>
<p><strong>docker pull</strong>：下载镜像</p>
<p><strong>docker images</strong>：列出所有的镜像</p>
<ul>
<li>这里加上|grep 管道符是为了过滤出来pause镜像</li>
</ul>
<p><strong>docker tag</strong>：给镜像打名字</p>
<p><strong>docker push</strong>：将镜像推送到指定的仓库</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"># 21/21机器，注意修改主机名，有一处需要改：hdss7-21</span><br><span class="line">bin]# vi /opt/kubernetes/server/bin/kubelet.sh</span><br><span class="line">#!/bin/sh</span><br><span class="line">./kubelet \</span><br><span class="line">  --anonymous-auth=false \</span><br><span class="line">  --cgroup-driver systemd \</span><br><span class="line">  --cluster-dns 192.168.0.2 \</span><br><span class="line">  --cluster-domain cluster.local \</span><br><span class="line">  --runtime-cgroups=/systemd/system.slice \</span><br><span class="line">  --kubelet-cgroups=/systemd/system.slice \</span><br><span class="line">  --fail-swap-on=&quot;false&quot; \</span><br><span class="line">  --authentication-token-webhook=true \</span><br><span class="line">  --authorization-mode=AlwaysAllow \</span><br><span class="line">  --client-ca-file ./cert/ca.pem \</span><br><span class="line">  --tls-cert-file ./cert/kubelet.pem \</span><br><span class="line">  --tls-private-key-file ./cert/kubelet-key.pem \</span><br><span class="line">  --hostname-override hdss7-21.host.com \</span><br><span class="line">  --image-gc-high-threshold 20 \</span><br><span class="line">  --image-gc-low-threshold 10 \</span><br><span class="line">  --kubeconfig ./conf/kubelet.kubeconfig \</span><br><span class="line">  --log-dir /data/logs/kubernetes/kube-kubelet \</span><br><span class="line">  --pod-infra-container-image harbor.od.com/public/pause:latest \</span><br><span class="line">  --root-dir /data/kubelet</span><br><span class="line">  </span><br><span class="line">conf]# cd /opt/kubernetes/server/bin</span><br><span class="line">bin]# mkdir -p /data/logs/kubernetes/kube-kubelet /data/kubelet</span><br><span class="line">bin]# chmod +x kubelet.sh</span><br><span class="line"># 有一处要修改：kube-kubelet-7-21]</span><br><span class="line">bin]# vi /etc/supervisord.d/kube-kubelet.ini</span><br><span class="line">[program:kube-kubelet-7-21]</span><br><span class="line">command=/opt/kubernetes/server/bin/kubelet.sh     ; the program (relative uses PATH, can take args)</span><br><span class="line">numprocs=1                                        ; number of processes copies to start (def 1)</span><br><span class="line">directory=/opt/kubernetes/server/bin              ; directory to cwd to before exec (def no cwd)</span><br><span class="line">autostart=true                                    ; start at supervisord start (default: true)</span><br><span class="line">autorestart=true              		          ; retstart at unexpected quit (default: true)</span><br><span class="line">startsecs=30                                      ; number of secs prog must stay running (def. 1)</span><br><span class="line">startretries=3                                    ; max # of serial start failures (default 3)</span><br><span class="line">exitcodes=0,2                                     ; &#x27;expected&#x27; exit codes for process (default 0,2)</span><br><span class="line">stopsignal=QUIT                                   ; signal used to kill process (default TERM)</span><br><span class="line">stopwaitsecs=10                                   ; max num secs to wait b4 SIGKILL (default 10)</span><br><span class="line">user=root                                         ; setuid to this UNIX account to run the program</span><br><span class="line">redirect_stderr=true                              ; redirect proc stderr to stdout (default false)</span><br><span class="line">stdout_logfile=/data/logs/kubernetes/kube-kubelet/kubelet.stdout.log   ; stderr log path, NONE for none; default AUTO</span><br><span class="line">stdout_logfile_maxbytes=64MB                      ; max # logfile bytes b4 rotation (default 50MB)</span><br><span class="line">stdout_logfile_backups=4                          ; # of stdout logfile backups (default 10)</span><br><span class="line">stdout_capture_maxbytes=1MB                       ; number of bytes in &#x27;capturemode&#x27; (default 0)</span><br><span class="line">stdout_events_enabled=false                       ; emit events on stdout writes (default false)</span><br><span class="line"></span><br><span class="line">bin]# supervisorctl update</span><br><span class="line">bin]# supervisorctl status</span><br><span class="line">bin]# kubectl get nodes</span><br><span class="line"># 给标签,21/22都给上master,node</span><br><span class="line">bin]# kubectl label node hdss7-21.host.com node-role.kubernetes.io/master=</span><br><span class="line">bin]# kubectl label node hdss7-21.host.com node-role.kubernetes.io/node=</span><br><span class="line">bin]# kubectl label node hdss7-22.host.com node-role.kubernetes.io/master=</span><br><span class="line">bin]# kubectl label node hdss7-22.host.com node-role.kubernetes.io/node=</span><br><span class="line">bin]# kubectl get nodes</span><br></pre></td></tr></table></figure>

<p><img    class="lazyload" data-original="https://gitee.com/ginohuang/k8s-paas/raw/master/assets/1579071142869.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="   ><span class="image-caption">1579071142869</span></p>
<p>完成</p>
<h3 id="安装部署运算节点服务（kube-proxy）"><a href="#安装部署运算节点服务（kube-proxy）" class="headerlink" title="安装部署运算节点服务（kube-proxy）"></a>安装部署运算节点服务（kube-proxy）</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"># 签发证书请求文件，200：</span><br><span class="line">[root@hdss7-200 ~]# cd /opt/certs</span><br><span class="line">200 certs]# vi kube-proxy-csr.json</span><br><span class="line">&#123;</span><br><span class="line">    &quot;CN&quot;: &quot;system:kube-proxy&quot;,</span><br><span class="line">    &quot;key&quot;: &#123;</span><br><span class="line">        &quot;algo&quot;: &quot;rsa&quot;,</span><br><span class="line">        &quot;size&quot;: 2048</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;names&quot;: [</span><br><span class="line">        &#123;</span><br><span class="line">            &quot;C&quot;: &quot;CN&quot;,</span><br><span class="line">            &quot;ST&quot;: &quot;beijing&quot;,</span><br><span class="line">            &quot;L&quot;: &quot;beijing&quot;,</span><br><span class="line">            &quot;O&quot;: &quot;od&quot;,</span><br><span class="line">            &quot;OU&quot;: &quot;ops&quot;</span><br><span class="line">        &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">200 certs]# cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=client kube-proxy-csr.json |cfssl-json -bare kube-proxy-client</span><br></pre></td></tr></table></figure>

<p><img    class="lazyload" data-original="https://gitee.com/hackxu/img/raw/master/docker/202111112303757.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="   ><span class="image-caption">1580437266613</span></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"># 分发证书，21/22机器：</span><br><span class="line">cd /opt/kubernetes/server/bin/cert</span><br><span class="line">cert]# scp hdss7-200.host.com:/opt/certs/kube-proxy-client.pem .</span><br><span class="line">cert]# scp hdss7-200.host.com:/opt/certs/kube-proxy-client-key.pem .</span><br><span class="line">cd ../conf/</span><br><span class="line"># 21机器：</span><br><span class="line">conf]# kubectl config set-cluster myk8s \</span><br><span class="line">  --certificate-authority=/opt/kubernetes/server/bin/cert/ca.pem \</span><br><span class="line">  --embed-certs=true \</span><br><span class="line">  --server=https://10.4.7.10:7443 \</span><br><span class="line">  --kubeconfig=kube-proxy.kubeconfig</span><br><span class="line"></span><br><span class="line">conf]# kubectl config set-credentials kube-proxy \</span><br><span class="line">  --client-certificate=/opt/kubernetes/server/bin/cert/kube-proxy-client.pem \</span><br><span class="line">  --client-key=/opt/kubernetes/server/bin/cert/kube-proxy-client-key.pem \</span><br><span class="line">  --embed-certs=true \</span><br><span class="line">  --kubeconfig=kube-proxy.kubeconfig</span><br><span class="line"></span><br><span class="line">conf]# kubectl config set-context myk8s-context \</span><br><span class="line">  --cluster=myk8s \</span><br><span class="line">  --user=kube-proxy \</span><br><span class="line">  --kubeconfig=kube-proxy.kubeconfig</span><br><span class="line"></span><br><span class="line">conf]# kubectl config use-context myk8s-context --kubeconfig=kube-proxy.kubeconfig</span><br><span class="line"></span><br><span class="line"># 22机器</span><br><span class="line">conf]# scp hdss7-21.host.com:/opt/kubernetes/server/bin/conf/kube-proxy.kubeconfig .</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 21/22机器：</span><br><span class="line">cd</span><br><span class="line">~]# lsmod |grep ip_vs</span><br><span class="line">~]# vi ipvs.sh</span><br><span class="line">#!/bin/bash</span><br><span class="line">ipvs_mods_dir=&quot;/usr/lib/modules/$(uname -r)/kernel/net/netfilter/ipvs&quot;</span><br><span class="line">for i in $(ls $ipvs_mods_dir|grep -o &quot;^[^.]*&quot;)</span><br><span class="line">do</span><br><span class="line">  /sbin/modinfo -F filename $i &amp;&gt;/dev/null</span><br><span class="line">  if [ $? -eq 0 ];then</span><br><span class="line">    /sbin/modprobe $i</span><br><span class="line">  fi</span><br><span class="line">done</span><br><span class="line"></span><br><span class="line">~]# chmod +x ipvs.sh</span><br><span class="line">~]# ./ipvs.sh</span><br><span class="line">~]# lsmod |grep ip_vs</span><br></pre></td></tr></table></figure>

<blockquote>
<p><strong>lsmod</strong>：显示已载入系统的模块</p>
<ul>
<li>后面带的管道符则是过滤出ip_vs来</li>
</ul>
<p><strong>chmod +x</strong>：给文件添加执行权限</p>
<p><strong>./ipvs.sh</strong>：运行文件</p>
</blockquote>
<p><img    class="lazyload" data-original="https://gitee.com/ginohuang/k8s-paas/raw/master/assets/1578846381651.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="   ><span class="image-caption">1578846381651</span></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"># 21/22机器：</span><br><span class="line">~]#cd /opt/kubernetes/server/bin/</span><br><span class="line"># 注意修改对应的机器ip，有一处修改：hdss7-21</span><br><span class="line">bin]# vi /opt/kubernetes/server/bin/kube-proxy.sh</span><br><span class="line">#!/bin/sh</span><br><span class="line">./kube-proxy \</span><br><span class="line">  --cluster-cidr 172.7.0.0/16 \</span><br><span class="line">  --hostname-override hdss7-21.host.com \</span><br><span class="line">  --proxy-mode=ipvs \</span><br><span class="line">  --ipvs-scheduler=nq \</span><br><span class="line">  --kubeconfig ./conf/kube-proxy.kubeconfig</span><br><span class="line">  </span><br><span class="line">bin]# chmod +x kube-proxy.sh</span><br><span class="line">bin]# mkdir -p /data/logs/kubernetes/kube-proxy</span><br><span class="line"># 注意机器IP，有一处修改：kube-proxy-7-21]</span><br><span class="line">bin]# vi /etc/supervisord.d/kube-proxy.ini</span><br><span class="line">[program:kube-proxy-7-21]</span><br><span class="line">command=/opt/kubernetes/server/bin/kube-proxy.sh                     ; the program (relative uses PATH, can take args)</span><br><span class="line">numprocs=1                                                           ; number of processes copies to start (def 1)</span><br><span class="line">directory=/opt/kubernetes/server/bin                                 ; directory to cwd to before exec (def no cwd)</span><br><span class="line">autostart=true                                                       ; start at supervisord start (default: true)</span><br><span class="line">autorestart=true                                                     ; retstart at unexpected quit (default: true)</span><br><span class="line">startsecs=30                                                         ; number of secs prog must stay running (def. 1)</span><br><span class="line">startretries=3                                                       ; max # of serial start failures (default 3)</span><br><span class="line">exitcodes=0,2                                                        ; &#x27;expected&#x27; exit codes for process (default 0,2)</span><br><span class="line">stopsignal=QUIT                                                      ; signal used to kill process (default TERM)</span><br><span class="line">stopwaitsecs=10                                                      ; max num secs to wait b4 SIGKILL (default 10)</span><br><span class="line">user=root                                                            ; setuid to this UNIX account to run the program</span><br><span class="line">redirect_stderr=true                                                 ; redirect proc stderr to stdout (default false)</span><br><span class="line">stdout_logfile=/data/logs/kubernetes/kube-proxy/proxy.stdout.log     ; stderr log path, NONE for none; default AUTO</span><br><span class="line">stdout_logfile_maxbytes=64MB                                         ; max # logfile bytes b4 rotation (default 50MB)</span><br><span class="line">stdout_logfile_backups=4                                             ; # of stdout logfile backups (default 10)</span><br><span class="line">stdout_capture_maxbytes=1MB                                          ; number of bytes in &#x27;capturemode&#x27; (default 0)</span><br><span class="line">stdout_events_enabled=false                                          ; emit events on stdout writes (default false)</span><br><span class="line"></span><br><span class="line">bin]# supervisorctl update</span><br><span class="line">bin]# yum install ipvsadm -y</span><br><span class="line">bin]# ipvsadm -Ln</span><br><span class="line">bin]# kubectl get svc</span><br></pre></td></tr></table></figure>

<blockquote>
<p><strong>ipvsadm</strong>：用于设置、维护和检查Linux内核中虚拟服务器列表的<em>命令</em></p>
<p><strong>ipvsadm -Ln</strong> ：查看当前配置的虚拟服务和各个RS的权重</p>
</blockquote>
<p><img    class="lazyload" data-original="https://gitee.com/ginohuang/k8s-paas/raw/master/assets/1578846997119.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="   ><span class="image-caption">1578846997119</span></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"># 验证一下集群，21机器(在任意节点机器，我选的是21)：</span><br><span class="line">cd</span><br><span class="line">~]# vi /root/nginx-ds.yaml</span><br><span class="line">apiVersion: extensions/v1beta1</span><br><span class="line">kind: DaemonSet</span><br><span class="line">metadata:</span><br><span class="line">  name: nginx-ds</span><br><span class="line">spec:</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: nginx-ds</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - name: my-nginx</span><br><span class="line">        image: harbor.od.com/public/nginx:v1.7.9</span><br><span class="line">        ports:</span><br><span class="line">        - containerPort: 80</span><br><span class="line">        </span><br><span class="line">~]# kubectl create -f nginx-ds.yaml</span><br><span class="line"># out：daemonset.extensions/nginx-ds created</span><br><span class="line">~]# kubectl get pods -o wide</span><br><span class="line"># 以下是成功的状态，在21/22机器都可以查到</span><br></pre></td></tr></table></figure>

<blockquote>
<p><strong>注意，如果你的pod的wide22的也在21上或者类似情况，那就是你的vi /etc/docker/daemon.json没改好机器名，需要重新做过全部机器</strong></p>
<p><strong>kubectl create -f</strong> ：通过配置文件名或stdin创建一个集群资源对象</p>
<p><strong>kubectl get … -o wide</strong>：显示网络情况</p>
<p><strong>nginx-ds.yaml解析：</strong></p>
<ul>
<li>可以参考这篇文章<a target="_blank" rel="noopener" href="https://www.baidu.com/link?url=tFECOG31lKlcqDWeAZGF1VyjhzVAN9vUKHKEKKw5G8y0AC8MKpJxSZeL647MIFdw&wd=&eqid=dafe84b80019e4a3000000065e51d2e2">点击跳转</a>，这里的nginx-ds.yaml建议自己手敲一遍，敲的同时要知道自己敲的是什么，记住，yaml语法不允许使用Tab键，只允许空格</li>
</ul>
</blockquote>
<p><img    class="lazyload" data-original="https://gitee.com/hackxu/img/raw/master/docker/202111112303247.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="   ><span class="image-caption">1578847257509</span></p>
<p>完成，此时你已经部署好K8S集群，当然只有集群还远远不够，我们还需要更多的东西才能组成我们的PaaS服务。</p>

      </section>
      <section class="extra">
        
          <ul class="copyright">
  
    <li><strong>本文作者：</strong>source</li>
    <li><strong>本文链接：</strong><a href="http://example.com/2021/12/15/K8S%E4%BA%8C%E8%BF%9B%E5%88%B6%E5%AE%89%E8%A3%85%E5%AE%9E%E6%88%98/index.html" title="http:&#x2F;&#x2F;example.com&#x2F;2021&#x2F;12&#x2F;15&#x2F;K8S%E4%BA%8C%E8%BF%9B%E5%88%B6%E5%AE%89%E8%A3%85%E5%AE%9E%E6%88%98&#x2F;index.html">http:&#x2F;&#x2F;example.com&#x2F;2021&#x2F;12&#x2F;15&#x2F;K8S%E4%BA%8C%E8%BF%9B%E5%88%B6%E5%AE%89%E8%A3%85%E5%AE%9E%E6%88%98&#x2F;index.html</a></li>
    <li><strong>版权声明：</strong>本博客所有文章均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" title="BY-NC-SA" target="_blank" rel="noopener">BY-NC-SA</a> 许可协议，转载请注明出处！</li>
  
</ul>
        
        
          <section class="donate">
  <div id="qrcode-donate">
    <img   class="lazyload" data-original="https://pic.izhaoo.com/alipay.jpg" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" >
  </div>
  <div class="icon">
    <a href="javascript:;" id="alipay"><i class="iconfont iconalipay"></i></a>
    <a href="javascript:;" id="wechat"><i class="iconfont iconwechat-fill"></i></a>
  </div>
</section>
        
        
  <ul class="tag-list" itemprop="keywords"><li class="tag-list-item"><a class="tag-list-link" href="/tags/K8S/" rel="tag">K8S</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/docker/" rel="tag">docker</a></li></ul> 

        
  <nav class="nav">
    <a></a>
    <a href="/2021/12/15/K8S%E5%AE%89%E8%A3%85%E6%96%B9%E5%BC%8F/">常见的K8S安装部署方式<i class="iconfont iconright"></i></a>
  </nav>

      </section>
      
    </section>
  </div>
</article></div>
      <div class="col-xl-3">
        
          
  <aside class="toc-wrap">
    <h3 class="toc-title">文章目录：</h3>
    <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#K8S%E4%BC%81%E4%B8%9A%E9%83%A8%E7%BD%B2%E5%AE%9E%E6%88%98"><span class="toc-text">K8S企业部署实战</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%83%A8%E7%BD%B2%E6%9E%B6%E6%9E%84%E5%9B%BE"><span class="toc-text">部署架构图</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%9E%E9%AA%8C%E7%8E%AF%E5%A2%83%E5%87%86%E5%A4%87"><span class="toc-text">实验环境准备</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%99%9A%E6%8B%9F%E6%9C%BA%E7%BD%91%E7%BB%9C%E8%AE%BE%E7%BD%AE"><span class="toc-text">虚拟机网络设置</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%85%B3%E9%97%AD%E9%98%B2%E7%81%AB%E5%A2%99%E5%92%8CSElinux%EF%BC%88%E5%BE%88%E9%87%8D%E8%A6%81%EF%BC%81%EF%BC%81%EF%BC%81%EF%BC%81%EF%BC%89"><span class="toc-text">关闭防火墙和SElinux（很重要！！！！）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#11%E6%9C%BA%E5%99%A8%E9%85%8D%E7%BD%AEDNS%E6%9C%8D%E5%8A%A1"><span class="toc-text">11机器配置DNS服务</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%87%86%E5%A4%87%E7%AD%BE%E5%8F%91%E8%AF%81%E4%B9%A6%E7%8E%AF%E5%A2%83"><span class="toc-text">准备签发证书环境</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%83%A8%E7%BD%B2Docker%E7%8E%AF%E5%A2%83"><span class="toc-text">部署Docker环境</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%83%A8%E7%BD%B2docker%E7%A7%81%E6%9C%89%E9%95%9C%E5%83%8F%E4%BB%93%E5%BA%93"><span class="toc-text">部署docker私有镜像仓库</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%89%E8%A3%85%E9%83%A8%E7%BD%B2%E4%B8%BB%E6%8E%A7%E8%8A%82%E7%82%B9%E6%9C%8D%E5%8A%A1etcd"><span class="toc-text">安装部署主控节点服务etcd</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%89%E8%A3%85API-server%E9%9B%86%E7%BE%A4"><span class="toc-text">安装API-server集群</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%89%E8%A3%85%E9%83%A8%E7%BD%B2%E4%B8%BB%E6%8E%A7%E8%8A%82%E7%82%B9L4%E5%8F%8D%E4%BB%A3%E6%9C%8D%E5%8A%A1"><span class="toc-text">安装部署主控节点L4反代服务</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%89%E8%A3%85%E9%83%A8%E7%BD%B2controller-manager%EF%BC%88%E8%8A%82%E7%82%B9%E6%8E%A7%E5%88%B6%E5%99%A8-%E8%B0%83%E5%BA%A6%E5%99%A8%E6%9C%8D%E5%8A%A1%EF%BC%89"><span class="toc-text">安装部署controller-manager（节点控制器&#x2F;调度器服务）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%89%E8%A3%85%E9%83%A8%E7%BD%B2%E8%BF%90%E7%AE%97%E8%8A%82%E7%82%B9%E6%9C%8D%E5%8A%A1%EF%BC%88kubelet%EF%BC%89"><span class="toc-text">安装部署运算节点服务（kubelet）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%89%E8%A3%85%E9%83%A8%E7%BD%B2%E8%BF%90%E7%AE%97%E8%8A%82%E7%82%B9%E6%9C%8D%E5%8A%A1%EF%BC%88kube-proxy%EF%BC%89"><span class="toc-text">安装部署运算节点服务（kube-proxy）</span></a></li></ol></li></ol></li></ol>
  </aside>

        
      </div>
    </div>
  </div>
</main>
  

<footer class="footer">
  <div class="footer-social"><a 
        href="tencent://message/?Menu=yes&uin=894519210 "
        target="_blank"
        class="footer-social-item"
        onMouseOver="this.style.color= '#12B7F5'" 
        onMouseOut="this.style.color='#33333D'">
          <i class="iconfont  iconQQ "></i>
      </a><a 
        href="javascript:; "
        target="_blank"
        class="footer-social-item"
        onMouseOver="this.style.color= '#09BB07'" 
        onMouseOut="this.style.color='#33333D'">
          <i class="iconfont  iconwechat-fill "></i>
      </a><a 
        href="https://www.instagram.com/izhaoo/ "
        target="_blank"
        class="footer-social-item"
        onMouseOver="this.style.color= '#DA2E76'" 
        onMouseOut="this.style.color='#33333D'">
          <i class="iconfont  iconinstagram "></i>
      </a><a 
        href="https://github.com/zhaoo "
        target="_blank"
        class="footer-social-item"
        onMouseOver="this.style.color= '#9f7be1'" 
        onMouseOut="this.style.color='#33333D'">
          <i class="iconfont  icongithub-fill "></i>
      </a><a 
        href="mailto:izhaoo@163.com "
        target="_blank"
        class="footer-social-item"
        onMouseOver="this.style.color=#FF3B00" 
        onMouseOut="this.style.color='#33333D'">
          <i class="iconfont  iconmail"></i>
      </a></div>
  
    <div class="footer-copyright"><p>Powered by <a target="_blank" href="https://hexo.io">Hexo</a>  |  Theme - <a target="_blank" href="https://github.com/izhaoo/hexo-theme-zhaoo">zhaoo</a></p></div>
  
</footer>
  
      <div class="fab fab-plus">
    <i class="iconfont iconplus"></i>
  </div>
  
  
  <div class="fab fab-up">
    <i class="iconfont iconcaret-up"></i>
  </div>
  
  
  
    
<script src="/js/color-mode.js"></script>

  
  
</body>

<script src="https://cdn.bootcss.com/jquery/3.4.1/jquery.min.js"></script>



  
<script src="https://cdn.bootcdn.net/ajax/libs/jquery.lazyload/1.9.1/jquery.lazyload.min.js"></script>




  
<script src="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.7/jquery.fancybox.min.js"></script>






  
<script src="https://cdn.bootcdn.net/ajax/libs/jquery.qrcode/1.0/jquery.qrcode.min.js"></script>




<script src="/js/utils.js"></script>
<script src="/js/script.js"></script>







  <script>
    (function () {
      var bp = document.createElement('script');
      var curProtocol = window.location.protocol.split(':')[0];
      if (curProtocol === 'https') {
        bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
      } else {
        bp.src = 'http://push.zhanzhang.baidu.com/push.js';
      }
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(bp, s);
    })();
  </script>













</html>